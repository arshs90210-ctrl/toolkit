<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alkegen Scheduler v5.1 (Authenticated)</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    /* CORE VARIABLES & RESET */
    :root { --bg-light: #f8fafc; --panel-light: #ffffff; --border-light: #e2e8f0; --text-dark: #1e293b; --accent: #2563eb; }
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: var(--bg-light); color: var(--text-dark); overflow: hidden; margin: 0; }
    
    /* SCROLLBARS */
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: var(--bg-light); }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; border: 2px solid var(--bg-light); }
    
    /* AUTH STYLES */
    .app-container { display: flex; flex-direction: column; height: 100vh; }
    .hidden { display: none !important; }
    
    .login-wrapper { position: fixed; inset: 0; background: #f1f5f9; z-index: 9000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); width: 100%; max-width: 400px; border: 1px solid #e2e8f0; }

    /* ADMIN TOGGLES */
    .admin-only { display: none !important; }
    body.is-admin .admin-only { display: inline-flex !important; }
    
    /* APP STRUCTURE */
    header { background: var(--panel-light); border-bottom: 1px solid var(--border-light); padding: 0 1.5rem; height: 64px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; z-index: 50; }
    .nav-group { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; border: 1px solid var(--border-light); }
    .nav-btn { padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; color: #64748b; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
    .nav-btn:hover { color: var(--text-dark); background: white; shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .nav-btn.active { background: white; color: var(--accent); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    /* GANTT LAYOUT - FIXED SCROLLING */
    .gantt-wrapper { 
        display: flex; 
        flex: 1; 
        overflow: hidden; 
        position: relative; 
        background: #f8fafc; 
    }
    
    /* The Main Container handles BOTH X and Y scrolling */
    .gantt-scroll-container { 
        display: flex; 
        flex: 1; 
        overflow: auto; /* Allow both scrollbars here */
        position: relative; 
        will-change: scroll-position;
    }

    /* Sidebar Sticks to the Left */
    .gantt-sidebar { 
        width: 550px; 
        background: white; 
        border-right: 1px solid var(--border-light); 
        display: flex; 
        flex-direction: column; 
        flex-shrink: 0; 
        
        /* Sticky Positioning for Sidebar */
        position: sticky; 
        left: 0; 
        z-index: 50; 
        box-shadow: 4px 0 6px -1px rgba(0,0,0,0.05);
    }

    /* Chart just expands to fit content */
    .gantt-chart { 
        flex: 1; 
        position: relative; 
        overflow: visible; /* Let the parent handle scrolling */
        background: white; 
    }

    /* Ensure Headers Line Up */
    .gantt-header-row { 
        display: flex; 
        width: 100%; 
        background: var(--bg-light); 
        border-bottom: 1px solid var(--border-light); 
        flex-shrink: 0;
        z-index: 60;
    }

    .sidebar-header { width: 550px; flex-shrink: 0; background: #f1f5f9; border-right: 1px solid var(--border-light); z-index: 61; }
    
    .timeline-header-wrapper { 
        flex: 1; 
        overflow: hidden; /* Hide scrollbar here, we sync via JS */
        position: relative; 
        background: #f8fafc; 
    }
    
    /* TABLES */
    .data-table { width: 100%; border-collapse: collapse; font-size: 11px; table-layout: fixed; }
    .data-table th { background: #f1f5f9; color: #475569; text-align: left; padding: 12px 8px; border-bottom: 1px solid var(--border-light); font-weight: 700; text-transform: uppercase; height: 60px; box-sizing: border-box; }
    .data-table td { padding: 0 8px; border-bottom: 1px solid #f1f5f9; color: #334155; height: 40px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
    .data-table tr:hover { background: #f0f9ff; }
    
    /* TIMELINE */
    .timeline-header { height: 60px; display: flex; }
    .day-col { flex-shrink: 0; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 10px; color: #64748b; position: relative; background: white; height: 100%; }
    .day-col.weekend { background: #f8fafc; }
    
    /* BARS */
    .chart-row { height: 40px; border-bottom: 1px dashed #e2e8f0; position: relative; width: 100%; }
    .bar { position: absolute; height: 24px; top: 8px; border-radius: 4px; font-size: 9px; font-weight: 600; color: white; display: flex; align-items: center; padding-left: 4px; overflow: hidden; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 10; border: 1px solid rgba(255,255,255,0.2); transition: all 0.1s; }
    .bar:hover { z-index: 50; transform: scale(1.02); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); }
    
    /* Dynamic Colors */
    .bar-card { background: #3b82f6; border-left: 3px solid #93c5fd; }
    .bar-fin { background: #8b5cf6; border-left: 3px solid #c4b5fd; }
    .bar-qc { background: #f97316; border-left: 3px solid #fdba74; }
    .bar-forced { border: 2px solid #ef4444; } /* Red border for user overrides */

    /* UTILS */
    .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 1000; display: none; align-items: center; justify-content: center; }
    .modal-content { background: white; border: 1px solid var(--border-light); border-radius: 12px; padding: 24px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-height: 80vh; overflow-y: auto; }
    .tooltip { position: fixed; background: #1e293b; color: white; padding: 8px 12px; border-radius: 6px; font-size: 11px; z-index: 2000; pointer-events: none; display: none; }
    .late-row { background-color: #fef2f2 !important; }
    .late-text { color: #dc2626 !important; font-weight: bold; }
    .override-text { color: #d97706; font-weight: bold; } /* Amber for overrides */
  </style>
</head>
<body>

<div id="loginScreen" class="login-wrapper">
    <div class="mb-8 text-center">
        <div class="w-16 h-16 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg mx-auto mb-4">
            <i class="fa-solid fa-industry text-white text-2xl"></i>
        </div>
        <h1 class="text-2xl font-bold text-slate-800">Alkegen Scheduler</h1>
        <p class="text-slate-500 text-sm">Secure Production System</p>
    </div>
    <div class="login-box">
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label>
                <input type="email" id="email" class="w-full border border-slate-300 rounded p-2 text-sm" placeholder="email@alkegen.com">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                <input type="password" id="password" class="w-full border border-slate-300 rounded p-2 text-sm" placeholder="••••••••">
            </div>
            <button onclick="handleLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded transition shadow-md">Sign In</button>
            <p id="loginError" class="text-red-500 text-xs text-center hidden"></p>
        </div>
    </div>
</div>

<div id="mainApp" class="app-container hidden">
    <header>
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center shadow-md">
                <i class="fa-solid fa-industry text-white"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg text-slate-800 leading-tight">Alkegen <span class="text-blue-600">Production</span></h1>
                <div class="flex items-center gap-2 text-xs text-slate-500 font-medium">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span> <span id="userRoleBadge">Viewer</span> Mode
                </div>
            </div>
        </div>

        <nav class="nav-group">
            <button onclick="switchView('gantt')" id="nav-gantt" class="nav-btn active"><i class="fa-solid fa-layer-group"></i>Schedule</button>
            <button onclick="switchView('sequencing')" id="nav-sequencing" class="nav-btn"><i class="fa-solid fa-route"></i>Sequencing</button>
            <button onclick="switchView('staffing')" id="nav-staffing" class="nav-btn"><i class="fa-solid fa-users"></i>Staffing</button>
            <button onclick="switchView('rates')" id="nav-rates" class="nav-btn"><i class="fa-solid fa-sliders"></i>Rates</button>
            <button onclick="switchView('kpi')" id="nav-kpi" class="nav-btn"><i class="fa-solid fa-chart-pie"></i>Analytics</button>
            <button onclick="switchView('downtime')" id="nav-downtime" class="nav-btn"><i class="fa-solid fa-triangle-exclamation"></i>Downtime</button>
        </nav>

        <div class="flex items-center gap-3">
            <span id="userEmailDisplay" class="text-xs text-slate-400 mr-2 font-mono"></span>
            
            <button onclick="showModal('uploadModal')" class="admin-only px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold rounded-lg shadow-sm transition flex items-center gap-2">
                <i class="fa-solid fa-cloud-arrow-up"></i> Import Data
            </button>
            
            <button onclick="exportExcel()" class="w-9 h-9 flex items-center justify-center text-green-600 hover:bg-green-50 rounded-lg border border-green-200 transition" title="Export Excel">
                <i class="fa-solid fa-file-excel text-lg"></i>
            </button>

            <button onclick="handleLogout()" class="w-9 h-9 flex items-center justify-center text-slate-400 hover:bg-slate-100 rounded-lg border border-slate-200 transition" title="Logout">
                <i class="fa-solid fa-right-from-bracket"></i>
            </button>
        </div>
    </header>

    <div id="view-gantt" class="flex-1 flex flex-col relative fade-in overflow-hidden">
        <div class="h-14 border-b border-slate-200 bg-white flex items-center justify-between px-6 flex-shrink-0 z-40">
            <div class="flex items-center gap-6">
                <div class="flex flex-col">
                    <label class="text-[10px] uppercase font-bold text-slate-500 tracking-wider">Start Date</label>
                    <input type="date" id="simDate" class="text-xs border-none bg-transparent font-bold text-slate-700 p-0 focus:ring-0 cursor-pointer hover:text-blue-600 transition" onchange="runEngine()">
                </div>
                <div class="h-8 w-px bg-slate-200"></div>
                <div class="flex items-center gap-3 group relative">
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="campaignMode" class="sr-only peer" checked onchange="runEngine()">
                        <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                        <span class="ml-2 text-xs font-bold text-slate-600 group-hover:text-slate-900 transition">Campaign Mode</span>
                    </label>
                </div>
                <div class="h-8 w-px bg-slate-200"></div>
                <div class="text-xs font-mono">
                    <span class="text-slate-500">ENGINE: </span>
                    <span id="engineStatus" class="text-green-600 font-bold">READY</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center bg-slate-100 rounded-lg p-1 border border-slate-200">
                    <button onclick="changeZoom(-10)" class="w-7 h-7 flex items-center justify-center text-slate-500 hover:text-blue-600 hover:bg-white rounded transition"><i class="fa-solid fa-minus"></i></button>
                    <span class="px-2 text-xs font-mono text-slate-500 select-none">ZOOM</span>
                    <button onclick="changeZoom(10)" class="w-7 h-7 flex items-center justify-center text-slate-500 hover:text-blue-600 hover:bg-white rounded transition"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
        </div>

        <div class="gantt-header-row">
            <div class="sidebar-header">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 80px">Status</th>
                            <th style="width: 90px">Order</th>
                            <th style="width: 130px">Felt Code</th>
                            <th style="width: 100px">Card</th>
                            <th style="width: 100px">Fin</th>
                            <th style="width: 50px; text-align: right">Bal</th>
                        </tr>
                    </thead>
                </table>
            </div>
            <div class="timeline-header-wrapper" id="timelineHeaderWrapper">
                <div id="timelineHeader" class="timeline-header"></div>
            </div>
        </div>

        <div class="gantt-wrapper">
            <div class="gantt-scroll-container" id="mainScroll">
                <div class="gantt-sidebar">
                    <table class="data-table">
                        <tbody id="taskTableBody"></tbody>
                    </table>
                </div>
                <div class="gantt-chart" id="ganttChart">
                    <div id="todayLine" style="position: absolute; top: 0; bottom: 0; width: 1px; background: #ef4444; z-index: 40; pointer-events: none; border-left: 1px dashed #ef4444;"></div>
                    <div id="timelineBody" class="pb-24"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-sequencing" class="flex-1 hidden bg-white p-8 fade-in overflow-auto">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Machine Preferences</h2>
                    <p class="text-sm text-slate-500">Define preferred machines per Felt Code. Engine tries 1st choice, then 2nd, etc.</p>
                </div>
                <div class="flex gap-2 admin-only">
                    <button onclick="document.getElementById('massSeqModal').style.display='flex'" class="px-4 py-2 bg-slate-100 border border-slate-300 text-slate-700 font-bold rounded hover:bg-white transition"><i class="fa-solid fa-layer-group mr-2"></i>Mass Edit</button>
                    <button onclick="addNewRouteRow()" class="px-4 py-2 bg-blue-600 text-white font-bold rounded shadow hover:bg-blue-700">+ Add Rule</button>
                </div>
            </div>
            <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200">
                        <tr>
                            <th class="p-4">Felt Code</th>
                            <th class="p-4">Carding Options</th>
                            <th class="p-4">Finishing Options</th>
                            <th class="p-4">QC Options</th>
                            <th class="p-4 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="sequencingTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-staffing" class="flex-1 hidden bg-white p-8 fade-in overflow-auto">
        <div class="max-w-5xl mx-auto">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Machine Staffing</h2>
                    <p class="text-sm text-slate-500">Control availability per machine. Unchecked shifts are treated as downtime.</p>
                </div>
                <button onclick="runEngine()" class="admin-only px-4 py-2 bg-green-600 text-white font-bold rounded shadow hover:bg-green-700">Apply & Re-Schedule</button>
            </div>
            <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200">
                        <tr>
                            <th class="p-4">Specific Machine</th>
                            <th class="p-4 text-center">Day (08:00 - 16:00)</th>
                            <th class="p-4 text-center">Swing (16:00 - 00:00)</th>
                            <th class="p-4 text-center">Night (00:00 - 08:00)</th>
                        </tr>
                    </thead>
                    <tbody id="staffingTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-rates" class="flex-1 hidden bg-white p-8 fade-in overflow-auto">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-end mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Rates & Changeovers</h2>
                <div class="flex gap-3">
                    <div class="bg-slate-50 p-2 rounded-lg border border-slate-200 flex items-center gap-3">
                        <span class="text-xs font-bold text-slate-500 uppercase ml-2">Setup Penalty</span>
                        <input type="number" id="setupPenalty" value="4" class="w-16 bg-white border border-slate-300 text-slate-700 rounded px-2 py-1 text-center font-mono text-sm" onchange="runEngine()">
                        <span class="text-xs text-slate-500 mr-2">hours</span>
                    </div>
                    <div class="flex gap-3 admin-only">
                        <button onclick="document.getElementById('massRateModal').style.display='flex'" class="px-4 py-2 bg-slate-100 border border-slate-300 text-slate-700 font-bold rounded hover:bg-white transition">Mass Update</button>
                        <button onclick="addNewRateRow()" class="px-4 py-2 bg-blue-600 text-white font-bold rounded shadow hover:bg-blue-700">+ Add Rate</button>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg border border-slate-200 overflow-hidden shadow-sm">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200">
                        <tr>
                            <th class="p-4 w-1/3">Felt Code</th>
                            <th class="p-4 text-right">Carding (yds/hr)</th>
                            <th class="p-4 text-right">Finishing (yds/hr)</th>
                            <th class="p-4 text-right">QC (yds/hr)</th>
                            <th class="p-4 w-20 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ratesTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-kpi" class="flex-1 hidden bg-white p-8 fade-in overflow-auto">
        <div class="max-w-7xl mx-auto space-y-8">
            <h2 class="text-2xl font-bold text-slate-800">Operational Analytics</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><div class="text-xs font-bold text-slate-400 uppercase">Throughput</div><div class="text-3xl font-bold text-slate-800 mt-2" id="kpiYds">0</div></div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><div class="text-xs font-bold text-slate-400 uppercase">Revenue</div><div class="text-3xl font-bold text-green-600 mt-2" id="kpiRev">$0</div></div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><div class="text-xs font-bold text-slate-400 uppercase">Late Value</div><div class="text-3xl font-bold text-red-600 mt-2" id="kpiLate">$0</div></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-96">
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col">
                    <h3 class="text-sm font-bold text-slate-600 mb-6">Machine Load Balance</h3>
                    <div class="flex-grow relative"><canvas id="chartLoad"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col">
                    <h3 class="text-sm font-bold text-slate-600 mb-6">Revenue Forecast</h3>
                    <div class="flex-grow relative"><canvas id="chartRev"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-downtime" class="flex-1 hidden bg-white p-8 fade-in overflow-auto">
         <div class="max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Planned Downtime</h2>
            <div class="bg-white p-6 rounded-xl border border-slate-200 mb-8 shadow-sm grid grid-cols-1 md:grid-cols-4 gap-4 items-end admin-only">
                <select id="dtMachine" class="w-full bg-slate-50 border border-slate-300 rounded p-2 text-sm"></select>
                <input type="datetime-local" id="dtStart" class="w-full bg-slate-50 border border-slate-300 rounded p-2 text-sm">
                <input type="datetime-local" id="dtEnd" class="w-full bg-slate-50 border border-slate-300 rounded p-2 text-sm">
                <button onclick="addDowntime()" class="bg-red-600 text-white font-bold py-2 rounded text-sm shadow">Add Block</button>
            </div>
            <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                <table class="w-full text-sm text-left text-slate-600"><tbody id="dtBody" class="divide-y divide-slate-100"></tbody></table>
            </div>
        </div>
    </div>
</div>

<div id="uploadModal" class="modal-bg">
    <div class="modal-content">
        <h2 class="text-xl font-bold mb-6 text-slate-800 border-b border-slate-200 pb-2">Import Data</h2>
        <div class="space-y-4">
            <div class="border border-dashed border-slate-300 rounded-lg p-6 hover:bg-slate-50 transition cursor-pointer relative text-center group">
                <i class="fa-solid fa-microchip text-2xl text-blue-500 mb-2"></i>
                <div class="font-bold text-slate-700">1. Load Rates</div>
                <div class="text-xs text-slate-500" id="rateStatus">Rates.xlsx</div>
                <input type="file" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleRateUpload(this)">
            </div>
            <div class="border border-dashed border-slate-300 rounded-lg p-6 hover:bg-slate-50 transition cursor-pointer relative text-center group">
                <i class="fa-solid fa-file-csv text-2xl text-green-500 mb-2"></i>
                <div class="font-bold text-slate-700">2. Load Orders</div>
                <div class="text-xs text-slate-500" id="orderStatus">Open Orders.xlsx</div>
                <input type="file" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleOrderUpload(this)">
            </div>
            <div class="border border-dashed border-slate-300 rounded-lg p-6 hover:bg-slate-50 transition cursor-pointer relative text-center group">
                <i class="fa-solid fa-route text-2xl text-purple-500 mb-2"></i>
                <div class="font-bold text-slate-700">3. Load Digital Schedule</div>
                <div class="text-xs text-slate-500" id="routeStatus">Digital Schedule.xlsx</div>
                <input type="file" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleRouteUpload(this)">
            </div>
        </div>
        <div class="flex justify-end gap-3 mt-8">
            <button onclick="document.getElementById('uploadModal').style.display='none'" class="px-4 py-2 text-slate-500 font-bold text-sm">Cancel</button>
            <button onclick="runEngine()" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-lg">Initialize</button>
        </div>
    </div>
</div>

<div id="editOrderModal" class="modal-bg">
    <div class="modal-content w-[500px]">
        <h2 class="text-lg font-bold text-slate-800 mb-4">Edit Order <span id="editOrderId" class="text-blue-600"></span></h2>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Balance (Qty)</label>
                <input type="number" id="editQty" class="w-full bg-white border border-slate-300 text-slate-800 rounded p-2 text-sm">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Felt Code</label>
                <input type="text" id="editFelt" class="w-full bg-gray-100 border border-slate-300 text-slate-600 rounded p-2 text-sm" readonly>
            </div>
        </div>
        
        <div class="border-t border-slate-200 pt-4 mb-4">
            <h3 class="text-xs font-bold text-slate-800 mb-2 uppercase">Force Specific Machines (Override Logic)</h3>
            <div class="grid grid-cols-3 gap-3">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 mb-1">Carding</label>
                    <select id="forceCard" class="w-full bg-white border border-slate-300 text-slate-800 rounded p-2 text-xs">
                        <option value="">Auto (Engine)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 mb-1">Finishing</label>
                    <select id="forceFin" class="w-full bg-white border border-slate-300 text-slate-800 rounded p-2 text-xs">
                        <option value="">Auto (Engine)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 mb-1">QC</label>
                    <select id="forceQC" class="w-full bg-white border border-slate-300 text-slate-800 rounded p-2 text-xs">
                        <option value="">Auto (Engine)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="mt-6 flex justify-end gap-3">
            <button onclick="document.getElementById('editOrderModal').style.display='none'" class="px-4 py-2 text-slate-500 font-bold text-sm">Cancel</button>
            <button onclick="saveOrderEdit()" class="admin-only px-4 py-2 bg-blue-600 text-white font-bold rounded shadow hover:bg-blue-700">Save & Re-Run</button>
        </div>
    </div>
</div>

<div id="editRateModal" class="modal-bg">
    <div class="modal-content w-[400px]">
        <h2 class="text-lg font-bold text-slate-800 mb-4">Edit Rate: <span id="editRateFelt" class="text-blue-600"></span></h2>
        <div class="grid grid-cols-3 gap-3 mb-4">
            <div><label class="text-[10px] font-bold text-slate-500">Card</label><input type="number" id="editRateCard" class="w-full border rounded p-2 text-sm"></div>
            <div><label class="text-[10px] font-bold text-slate-500">Finishing</label><input type="number" id="editRateFin" class="w-full border rounded p-2 text-sm"></div>
            <div><label class="text-[10px] font-bold text-slate-500">QC</label><input type="number" id="editRateQC" class="w-full border rounded p-2 text-sm"></div>
        </div>
        <div class="flex justify-end gap-3">
            <button onclick="document.getElementById('editRateModal').style.display='none'" class="px-4 py-2 text-slate-500 text-sm font-bold">Cancel</button>
            <button onclick="saveRateEdit()" class="admin-only px-4 py-2 bg-blue-600 text-white text-sm font-bold rounded">Save</button>
        </div>
    </div>
</div>

<div id="massSeqModal" class="modal-bg">
    <div class="modal-content w-[400px]">
        <h2 class="text-lg font-bold text-slate-800 mb-4">Mass Update Preferences</h2>
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Felt Code Contains</label>
                <input type="text" id="massSeqFilter" class="w-full bg-white border border-slate-300 rounded p-2 text-sm" placeholder="e.g. AX-14">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Set Preferred Card</label>
                <select id="massSeqCard" class="w-full bg-white border border-slate-300 rounded p-2 text-sm"><option value="">No Change</option></select>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Set Preferred Finishing</label>
                <select id="massSeqFin" class="w-full bg-white border border-slate-300 rounded p-2 text-sm"><option value="">No Change</option></select>
            </div>
        </div>
        <div class="mt-6 flex justify-end gap-3">
            <button onclick="document.getElementById('massSeqModal').style.display='none'" class="px-4 py-2 text-slate-500 font-bold text-sm">Cancel</button>
            <button onclick="applyMassSeq()" class="admin-only px-4 py-2 bg-blue-600 text-white font-bold rounded">Apply</button>
        </div>
    </div>
</div>

<div id="massRateModal" class="modal-bg">
    <div class="modal-content w-[400px]">
        <h2 class="text-lg font-bold text-slate-800 mb-4">Mass Update Rates</h2>
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Felt Code Contains</label>
                <input type="text" id="massRateFilter" class="w-full bg-white border border-slate-300 rounded p-2 text-sm" placeholder="e.g. AX-14">
            </div>
            <div class="grid grid-cols-3 gap-2">
                <div><label class="text-[10px]">Card Rate</label><input type="number" id="massRateCard" class="w-full border rounded p-1"></div>
                <div><label class="text-[10px]">Fin Rate</label><input type="number" id="massRateFin" class="w-full border rounded p-1"></div>
                <div><label class="text-[10px]">QC Rate</label><input type="number" id="massRateQC" class="w-full border rounded p-1"></div>
            </div>
        </div>
        <div class="mt-6 flex justify-end gap-3">
            <button onclick="document.getElementById('massRateModal').style.display='none'" class="px-4 py-2 text-slate-500 font-bold text-sm">Cancel</button>
            <button onclick="applyMassRate()" class="admin-only px-4 py-2 bg-blue-600 text-white font-bold rounded">Apply</button>
        </div>
    </div>
</div>

<div id="tooltip" class="tooltip"></div>

<script id="worker-script" type="javascript/worker">
    self.onmessage = function(e) {
        const { orders, rates, config, downtime, simStart, routes, staffing, overrides } = e.data;
        const MACHINES = config.machines;
        
        let schedule = [];
        let now = simStart || new Date().getTime();
        let machineState = {};
        let activeDowntime = [...downtime];

        // 1. STAFFING DOWNTIME
        for(let d=0; d<60; d++) {
            const dayStart = now + (d * 86400000);
            const midnight = new Date(dayStart).setHours(0,0,0,0);
            Object.keys(staffing).forEach(machName => {
                const avail = staffing[machName];
                if(!avail) return;
                if(!avail[0]) activeDowntime.push({ machine: machName, start: midnight + (8*3600000), end: midnight + (16*3600000), reason: 'Staffing' });
                if(!avail[1]) activeDowntime.push({ machine: machName, start: midnight + (16*3600000), end: midnight + (24*3600000), reason: 'Staffing' });
                if(!avail[2]) activeDowntime.push({ machine: machName, start: midnight, end: midnight + (8*3600000), reason: 'Staffing' });
            });
        }

        // Init State
        MACHINES.forEach(m => { machineState[m] = { time: now, lastFelt: null }; });

        // 2. CAMPAIGN SORT
        let queue = [...orders];
        if (config.campaign) {
            queue.sort((a,b) => {
                const dateA = a.rtsDate || 9999999999999;
                const dateB = b.rtsDate || 9999999999999;
                const weekA = Math.floor(dateA / (7 * 86400000));
                const weekB = Math.floor(dateB / (7 * 86400000));
                if (weekA !== weekB) return weekA - weekB;
                if (a.felt < b.felt) return -1;
                if (a.felt > b.felt) return 1;
                return dateA - dateB;
            });
        } else {
            queue.sort((a,b) => a.rtsDate - b.rtsDate);
        }

        // 3. SCHEDULER
        queue.forEach(ord => {
            const r = rates[ord.felt] || Object.values(rates)[0] || {card:250, finish:700, qc:400};
            
            // Preference List from Sheet 4 (or generic fallback)
            let prefs = routes[ord.felt] || {
                card: MACHINES.filter(m => m.includes('Card')),
                fin: MACHINES.filter(m => m.includes('Bruckner') || m.includes('Kusters') || m.includes('Singer') || m.includes('Dilo')),
                qc: MACHINES.filter(m => m.includes('QC'))
            };

            // USER OVERRIDES
            if(overrides[ord.id]) {
                if(overrides[ord.id].card) prefs.card = [overrides[ord.id].card];
                if(overrides[ord.id].fin) prefs.fin = [overrides[ord.id].fin];
                if(overrides[ord.id].qc) prefs.qc = [overrides[ord.id].qc];
            }

            // STANDARD FLOW: Card -> Finish -> QC
            // For each stage, we pick the BEST machine from the prefs list (Greedy)
            // "Best" = Earliest Available + Setup Penalty
            
            // --- STEP 1: CARDING ---
            let cRes = allocate(prefs.card, now, (ord.qty / (r.card||250)), ord.felt);
            
            // --- STEP 2: FINISHING ---
            let fReady = cRes.end + 3600000; // 1hr move
            let fRes = allocate(prefs.fin, fReady, (ord.qty / (r.finish||700)), ord.felt);

            // --- STEP 3: QC ---
            let qReady = fRes.end + 1800000; // 30m move
            let qRes = allocate(prefs.qc, qReady, (ord.qty / (r.qc||400)), ord.felt);

            schedule.push({
                ...ord,
                card: cRes, fin: fRes, qc: qRes,
                allMachs: [cRes.mach, fRes.mach, qRes.mach],
                globalEnd: qRes.end,
                isLate: qRes.end > ord.rtsDate
            });
        });

        // Helper: Greedy Allocation
        function allocate(pool, readyTime, durHrs, felt) {
            if(!pool || pool.length === 0) return { mach:'Err', start:readyTime, end:readyTime };
            
            const durMs = durHrs * 3600000;
            let bestM = null;
            let bestFinish = Infinity;
            let bestStart = Infinity;

            pool.forEach(mName => {
                const mState = machineState[mName] || { time: now, lastFelt: null };
                let start = Math.max(mState.time, readyTime);
                
                // Setup Penalty
                if(mState.lastFelt && mState.lastFelt !== felt) start += (config.setupPenalty * 3600000);

                // Downtime Check
                let conflict = true;
                let attempts = 0;
                while(conflict && attempts < 50) {
                    conflict = false;
                    const potentialEnd = start + durMs;
                    const dt = activeDowntime.find(d => d.machine === mName && d.start < potentialEnd && d.end > start);
                    if (dt) {
                        start = dt.end;
                        conflict = true;
                    }
                    attempts++;
                }

                const end = start + durMs;
                if(end < bestFinish) {
                    bestFinish = end;
                    bestStart = start;
                    bestM = mName;
                }
            });

            if(bestM) {
                if(!machineState[bestM]) machineState[bestM] = { time: now, lastFelt: null };
                machineState[bestM].time = bestFinish;
                machineState[bestM].lastFelt = felt;
                return { mach: bestM, start: bestStart, end: bestFinish };
            }
            return { mach:'Err', start:readyTime, end:readyTime+durMs };
        }

        // 4. ANALYTICS
        let dayLoads = {};
        schedule.forEach(s => {
            [s.card, s.fin, s.qc].forEach(t => {
                if(t.start && t.end) {
                    const startDay = Math.floor(t.start / 86400000);
                    const endDay = Math.floor(t.end / 86400000);
                    for(let i=startDay; i<=endDay; i++) dayLoads[i] = (dayLoads[i]||0) + 1;
                }
            });
        });

        self.postMessage({ schedule, dayLoads });
    };
</script>

<script>
    // --- SUPABASE CONNECTIVITY ---
    const SB_URL = 'https://tihzqfpyfanohnazvkcx.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpaHpxZnB5ZmFub2huYXp2a2N4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NzY5MDAsImV4cCI6MjA4MDI1MjkwMH0.-ZbsX_CDTpNG3FRfH2KZcJjoj61z6JfHWQ7_cWyXAv0';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    // --- CONFIG & STATE ---
    const CONFIG = {
        machines: [
            'Card 1', 'Card 2', 'Card 3', 'Card 4', 'Card 5', 'Card 6', 'Card 7', 'Card 8', 'Card 9',
            'Bruckner 1', 'Bruckner 2', 'Kusters', 'Singer 1', 'Singer 2', 
            'Perkins', 'Hunter', 'Dilo', 'Fehrer 228', 'Heatset', 'Needleloom',
            'QC 1', 'QC 2', 'QC 3', 'QC 4', 'QC 5', 'QC 6', 'QC 7', 'QC 8', 'QC Lab'
        ],
        defaults: { card: 250, finish: 700, qc: 400 },
        setupPenalty: 4,
        campaign: true
    };

    let RATES = {};
    let DOWNTIME = [];
    let ROUTES = {}; 
    let STAFFING = {}; 
    let OVERRIDES = {}; 
    
    let RAW_ORDERS = [];
    let SCHEDULE = [];
    let DAY_LOADS = {};
    let WORKER = null;
    let ZOOM_PX = 60;
    let CHARTS = {};
    let USER_ROLE = 'viewer';

    // --- AUTHENTICATION & APP INIT ---
    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if (error) {
            document.getElementById('loginError').innerText = error.message;
            document.getElementById('loginError').classList.remove('hidden');
        } else {
            initApp(data.user);
        }
    }

    async function handleLogout() {
        await sb.auth.signOut();
        window.location.reload();
    }

    async function initApp(user) {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('userEmailDisplay').innerText = user.email;

        // Fetch User Role
        try {
            const { data, error } = await sb.from('user_roles').select('role').eq('id', user.id).single();
            if (data && data.role) USER_ROLE = data.role;
        } catch (e) {
            console.log('Role fetch failed, defaulting to viewer');
        }
        
        // Manual fallback for specific email if table is missing
        if(user.email.includes('admin') || user.email === 'admin@alkegen.com') USER_ROLE = 'admin';

        // Apply Role UI
        document.getElementById('userRoleBadge').innerText = USER_ROLE.charAt(0).toUpperCase() + USER_ROLE.slice(1);
        if (USER_ROLE === 'admin') {
            document.body.classList.add('is-admin');
        }

        // Init App Data
        document.getElementById('simDate').valueAsDate = new Date();
        CONFIG.machines.forEach(m => STAFFING[m] = [true, true, true]);
        initWorker();
        initUI();
        renderStaffingTable();
        
        // Try fetch existing rates/downtime from DB
        loadFromDB();

        // FIXED SCROLL SYNC
        const mainScroll = document.getElementById('mainScroll');
        const headerScroll = document.getElementById('timelineHeaderWrapper');

        mainScroll.addEventListener('scroll', () => {
            if(headerScroll) {
                headerScroll.scrollLeft = mainScroll.scrollLeft;
            }
        });
    }

    async function loadFromDB() {
        try {
            // Load downtime
            const { data: dt } = await sb.from('downtime').select('*');
            if(dt) {
                DOWNTIME = dt.map(d => ({
                    id: d.id, machine: d.machine, start: new Date(d.start_time).getTime(), end: new Date(d.end_time).getTime(), reason: d.reason
                }));
                renderDowntimeTable();
            }
            // Load rates
            const { data: rt } = await sb.from('rates').select('*');
            if(rt) {
                rt.forEach(r => {
                    RATES[r.felt_code] = { card: r.card_rate, finish: r.finish_rate, qc: r.qc_rate };
                });
                renderRatesTable();
            }
        } catch(e) { console.log('DB load skipped'); }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        // Check active session
        const { data: { session } } = await sb.auth.getSession();
        if (session) {
            initApp(session.user);
        }
        // Populate dropdowns regardless
        populateDropdowns();
    });

    function initWorker() {
        const blob = new Blob([document.getElementById('worker-script').textContent], {type: "text/javascript"});
        WORKER = new Worker(window.URL.createObjectURL(blob));
        WORKER.onmessage = (e) => {
            SCHEDULE = e.data.schedule;
            DAY_LOADS = e.data.dayLoads;
            renderAll();
            renderKPIs();
            document.getElementById('engineStatus').innerText = "ONLINE";
            document.getElementById('engineStatus').className = "text-green-600 font-bold";
            document.getElementById('uploadModal').style.display = 'none';
        };
    }

    function initUI() { populateDropdowns(); }

    function populateDropdowns() {
        ['dtMachine', 'massSeqCard', 'massSeqFin', 'forceCard', 'forceFin', 'forceQC'].forEach(id => {
            const sel = document.getElementById(id);
            if(!sel) return;
            const isFilter = id.includes('massSeq') || id.includes('force');
            if(isFilter) {
                if(id.includes('Card')) CONFIG.machines.filter(m=>m.includes('Card')).forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
                else if(id.includes('Fin')) CONFIG.machines.filter(m=>!m.includes('Card') && !m.includes('QC')).forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
                else if(id.includes('QC')) CONFIG.machines.filter(m=>m.includes('QC')).forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
                else CONFIG.machines.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
            } else {
                CONFIG.machines.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
            }
        });
    }

    // --- DATA LOADING ---
    function readFile(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => resolve(XLSX.read(new Uint8Array(e.target.result), {type: 'array'}));
            reader.readAsArrayBuffer(file);
        });
    }

    async function handleOrderUpload(inp) {
        const wb = await readFile(inp.files[0]);
        let rows = [];
        for(const sn of wb.SheetNames) {
            const raw = XLSX.utils.sheet_to_json(wb.Sheets[sn], {header:1});
            const idx = raw.findIndex(r => r && r.some(c => String(c).toUpperCase().includes('ORDER')));
            if(idx > -1) { rows = XLSX.utils.sheet_to_json(wb.Sheets[sn], {range:idx}); break; }
        }
        RAW_ORDERS = rows.map((r, i) => {
            let o = { id:`UNK-${i}`, felt:'Unknown', qty:0, val:0, status:'' };
            for(let k in r) {
                const ck = k.toUpperCase().trim();
                if(ck.includes('ORDER') && ck.includes('ID')) o.id = r[k];
                else if(ck.includes('FELT') || ck.includes('PART')) o.felt = r[k];
                else if(ck === 'BALANCE' || ck.includes('BAL YDS')) o.qty = parseFloat(r[k])||0;
                else if((ck.includes('QTY') || ck.includes('QUANTITY')) && o.qty === 0) o.qty = parseFloat(r[k])||0;
                else if(ck.includes('SALES') || ck.includes('VAL')) o.val = parseFloat(r[k])||0;
                else if(ck.includes('RTS') || ck === 'REQDATE') o.rtsRaw = r[k];
            }
            if(typeof o.rtsRaw === 'number') o.rtsDate = new Date(Math.round((o.rtsRaw - 25569)*86400*1000)).getTime();
            else if(o.rtsRaw) o.rtsDate = new Date(o.rtsRaw).getTime();
            else o.rtsDate = new Date('2099-12-31').getTime();
            return o;
        }).filter(o => o.qty > 0);
        document.getElementById('orderStatus').innerText = `${RAW_ORDERS.length} Orders Loaded`;
        document.getElementById('orderStatus').className = "text-green-600 text-xs";
    }

    async function handleRateUpload(inp) {
        const wb = await readFile(inp.files[0]);
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        data.forEach(r => {
            const code = r['Felt Code'] || r['Code'];
            if(code) {
                RATES[code.trim()] = {
                    card: parseFloat(r['Carding Rate (yds/hr)'] || 250),
                    finish: parseFloat(r['Finishing Rate (yds/hr)'] || 700),
                    qc: parseFloat(r['QC Rate (yds/hr)'] || 400)
                };
            }
        });
        document.getElementById('rateStatus').innerText = "Rates Loaded";
        document.getElementById('rateStatus').className = "text-green-600 text-xs";
        renderRatesTable();
    }

    async function handleRouteUpload(inp) {
        const wb = await readFile(inp.files[0]);
        let sheetName = wb.SheetNames.find(n => n.includes('Sheet4')) || wb.SheetNames[0];
        const data = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
        
        let tempRoutes = {};
        data.forEach(r => {
            const felt = r['FELTCODE'];
            const mach = r['MACHNAME'];
            if(felt && mach) {
                if(!tempRoutes[felt]) tempRoutes[felt] = { card:[], fin:[], qc:[] };
                const mUpper = mach.toUpperCase();
                const normMach = CONFIG.machines.find(m => m.toUpperCase().replace(/\s/g,'') === mach.toUpperCase().replace(/\s/g,'').replace('#','')) || mach;
                
                if(mUpper.includes('CARD')) tempRoutes[felt].card.push(normMach);
                else if(mUpper.includes('QC')) tempRoutes[felt].qc.push(normMach);
                else tempRoutes[felt].fin.push(normMach);
            }
        });
        ROUTES = tempRoutes;
        document.getElementById('routeStatus').innerText = "Digital Schedule Loaded";
        document.getElementById('routeStatus').className = "text-green-600 text-xs";
        renderSequencingTable();
    }

    // --- SEQUENCING TAB ---
    function renderSequencingTable() {
        const tb = document.getElementById('sequencingTableBody');
        tb.innerHTML = Object.keys(ROUTES).sort().map(f => {
            const r = ROUTES[f];
            return `
            <tr class="hover:bg-slate-50 border-b border-slate-100">
                <td class="p-4 font-bold text-blue-600">${f}</td>
                <td class="p-4 text-xs">${r.card.join(', ')}</td>
                <td class="p-4 text-xs">${r.fin.join(', ')}</td>
                <td class="p-4 text-xs">${r.qc.join(', ')}</td>
                <td class="p-4 text-center"><button onclick="editSequence('${f}')" class="text-blue-500 hover:underline text-xs">Edit</button></td>
            </tr>`;
        }).join('');
    }

    function editSequence(f) {
        if(USER_ROLE !== 'admin') return alert('Admin only');
        const r = ROUTES[f];
        const c = prompt(`Preferred Cards for ${f} (comma separated):`, r.card.join(','));
        const fn = prompt(`Preferred Finishing for ${f}:`, r.fin.join(','));
        if(c !== null && fn !== null) {
            ROUTES[f].card = c.split(',').map(s=>s.trim());
            ROUTES[f].fin = fn.split(',').map(s=>s.trim());
            renderSequencingTable();
            runEngine();
        }
    }

    function addNewRouteRow() {
        if(USER_ROLE !== 'admin') return alert('Admin only');
        const f = prompt("Enter new Felt Code:");
        if(f) {
            ROUTES[f] = { card:['Card 1'], fin:['Bruckner 1'], qc:['QC 1'] };
            renderSequencingTable();
        }
    }

    function applyMassSeq() {
        if(USER_ROLE !== 'admin') return alert('Admin only');
        const filter = document.getElementById('massSeqFilter').value.toUpperCase();
        const c = document.getElementById('massSeqCard').value;
        const f = document.getElementById('massSeqFin').value;
        
        Object.keys(ROUTES).forEach(k => {
            if(k.toUpperCase().includes(filter)) {
                if(c) ROUTES[k].card = [c];
                if(f) ROUTES[k].fin = [f];
            }
        });
        document.getElementById('massSeqModal').style.display='none';
        renderSequencingTable();
        runEngine();
    }

    // --- RATES TAB ---
    function renderRatesTable() {
        const tb = document.getElementById('ratesTableBody');
        tb.innerHTML = Object.keys(RATES).sort().map(k => `
            <tr class="hover:bg-slate-50 transition">
                <td class="p-4 font-mono text-blue-600 font-bold">${k}</td>
                <td class="p-4 text-right">${RATES[k].card}</td>
                <td class="p-4 text-right">${RATES[k].finish}</td>
                <td class="p-4 text-right">${RATES[k].qc}</td>
                <td class="p-4 text-center">
                    <button class="text-blue-500 hover:text-blue-700 mr-2 admin-only" onclick="openRateEdit('${k}')"><i class="fa-solid fa-pen"></i></button>
                    <button class="text-red-400 hover:text-red-600 admin-only" onclick="deleteRate('${k}')"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>`).join('');
    }

    function openRateEdit(felt) {
        if(USER_ROLE !== 'admin') return alert('Admin only');
        const r = RATES[felt];
        document.getElementById('editRateFelt').innerText = felt;
        document.getElementById('editRateCard').value = r.card;
        document.getElementById('editRateFin').value = r.finish;
        document.getElementById('editRateQC').value = r.qc;
        document.getElementById('editRateModal').style.display = 'flex';
    }

    async function saveRateEdit() {
        const felt = document.getElementById('editRateFelt').innerText;
        const c = parseFloat(document.getElementById('editRateCard').value);
        const f = parseFloat(document.getElementById('editRateFin').value);
        const q = parseFloat(document.getElementById('editRateQC').value);
        
        RATES[felt] = { card:c, finish:f, qc:q };
        
        try {
            await sb.from('rates').upsert({ felt_code: felt, card_rate: c, finish_rate: f, qc_rate: q });
        } catch(e) {}

        document.getElementById('editRateModal').style.display = 'none';
        renderRatesTable();
        runEngine(); // Re-run to reflect speed changes
    }

    function applyMassRate() {
        if(USER_ROLE !== 'admin') return alert('Admin only');
        const filter = document.getElementById('massRateFilter').value.toUpperCase();
        const c = parseFloat(document.getElementById('massRateCard').value);
        const f = parseFloat(document.getElementById('massRateFin').value);
        const q = parseFloat(document.getElementById('massRateQC').value);
        
        Object.keys(RATES).forEach(k => {
            if(k.toUpperCase().includes(filter)) {
                if(c) RATES[k].card = c;
                if(f) RATES[k].finish = f;
                if(q) RATES[k].qc = q;
            }
        });
        document.getElementById('massRateModal').style.display='none';
        renderRatesTable();
    }

    function addNewRateRow() {
        if(USER_ROLE !== 'admin') return alert('Admin only');
        const f = prompt("Enter Felt Code:");
        if(f) {
            RATES[f] = { card:250, finish:700, qc:400 };
            renderRatesTable();
        }
    }

    // --- MAIN SCHEDULER & EDITING ---
    function openEditModal(oid) {
        const o = RAW_ORDERS.find(x => x.id === oid);
        if(!o) return;
        document.getElementById('editOrderId').innerText = oid;
        document.getElementById('editQty').value = o.qty;
        document.getElementById('editFelt').value = o.felt;
        
        const ov = OVERRIDES[oid] || {};
        document.getElementById('forceCard').value = ov.card || "";
        document.getElementById('forceFin').value = ov.fin || "";
        document.getElementById('forceQC').value = ov.qc || "";
        
        document.getElementById('editOrderModal').style.display = 'flex';
    }

    function saveOrderEdit() {
        if(USER_ROLE !== 'admin') return alert('Admin only');
        const oid = document.getElementById('editOrderId').innerText;
        const q = parseFloat(document.getElementById('editQty').value);
        
        const idx = RAW_ORDERS.findIndex(x => x.id === oid);
        if(idx > -1) RAW_ORDERS[idx].qty = q;
        
        const fc = document.getElementById('forceCard').value;
        const ff = document.getElementById('forceFin').value;
        const fq = document.getElementById('forceQC').value;
        
        if(fc || ff || fq) {
            OVERRIDES[oid] = { card: fc, fin: ff, qc: fq };
        } else {
            delete OVERRIDES[oid];
        }
        
        document.getElementById('editOrderModal').style.display = 'none';
        runEngine();
    }

    // --- RENDER GANTT ---
    function renderAll() {
        const tbody = document.getElementById('taskTableBody');
        const timelineHeader = document.getElementById('timelineHeader');
        const timelineBody = document.getElementById('timelineBody');
        
        tbody.innerHTML = '';
        timelineHeader.innerHTML = '';
        timelineBody.innerHTML = '';

        if(!SCHEDULE.length) return;

        const now = document.getElementById('simDate').valueAsDate.getTime();
        const maxEnd = Math.max(...SCHEDULE.map(d=>d.globalEnd)) || now;
        const totalDays = Math.ceil((maxEnd - now) / 86400000) + 10;
        const width = totalDays * ZOOM_PX;

        timelineHeader.style.width = `${width}px`;
        const startDayIdx = Math.floor(now / 86400000);
        
        for(let i=0; i<totalDays; i++) {
            const t = now + (i * 86400000);
            const d = new Date(t);
            const isWk = d.getDay()===0 || d.getDay()===6;
            const load = DAY_LOADS[startDayIdx + i] || 0;
            const heatClass = load > 200 ? 'bg-red-500' : (load > 100 ? 'bg-amber-400' : 'bg-green-500');
            
            const div = document.createElement('div');
            div.className = `day-col ${isWk?'weekend':''}`;
            div.style.width = `${ZOOM_PX}px`;
            div.innerHTML = `
                <span class="mt-2 font-bold">${d.getDate()}</span>
                <span style="font-size:9px">${d.toLocaleString('default',{month:'short'})}</span>
                <div class="absolute bottom-0 left-0 right-0 h-1 ${heatClass} opacity-50"></div>
            `;
            timelineHeader.appendChild(div);
        }

        SCHEDULE.forEach(row => {
            const isForced = OVERRIDES[row.id];
            const tr = document.createElement('tr');
            if(row.isLate) tr.classList.add('late-row');
            tr.innerHTML = `
                <td><span class="inline-block w-2 h-2 rounded-full mr-2 ${row.isLate?'bg-red-500':'bg-green-500'}"></span>${row.status || 'New'}</td>
                <td class="font-mono text-xs cursor-pointer hover:text-blue-600 underline ${isForced?'override-text':''}" onclick="openEditModal('${row.id}')">${row.id} ${isForced?'*':''}</td>
                <td class="font-bold text-blue-600 text-xs">${row.felt}</td>
                <td class="text-[10px] text-slate-500">${row.card.mach}</td>
                <td class="text-[10px] text-slate-500">${row.fin.mach}</td>
                <td class="text-right font-mono text-xs">${row.qty.toLocaleString()}</td>
            `;
            tbody.appendChild(tr);

            const trDiv = document.createElement('div');
            trDiv.className = 'chart-row';
            trDiv.style.width = `${width}px`;

            const drawBar = (task, type) => {
                if(!task.start || task.mach === 'Err') return;
                const startPx = ((task.start - now) / 86400000) * ZOOM_PX;
                const durPx = Math.max(((task.end - task.start) / 86400000) * ZOOM_PX, 4);
                
                const b = document.createElement('div');
                b.className = `bar bar-${type} ${isForced?'bar-forced':''}`;
                b.style.left = `${startPx}px`;
                b.style.width = `${durPx}px`;
                b.innerText = task.mach;
                b.onclick = () => openEditModal(row.id);
                b.onmouseover = (e) => showTooltip(e, `${row.id} (${row.felt})\n${task.mach}\n${new Date(task.start).toLocaleString()} - ${new Date(task.end).toLocaleString()}`);
                b.onmouseout = () => document.getElementById('tooltip').style.display='none';
                trDiv.appendChild(b);
            };

            drawBar(row.card, 'card');
            drawBar(row.fin, 'fin');
            drawBar(row.qc, 'qc');
            timelineBody.appendChild(trDiv);
        });
    }

    // --- ANALYTICS ---
    function renderKPIs() {
        const totYds = SCHEDULE.reduce((a,b)=>a+b.qty,0);
        const totRev = SCHEDULE.reduce((a,b)=>a+b.val,0);
        const lateVal = SCHEDULE.filter(x=>x.isLate).reduce((a,b)=>a+b.val,0);
        
        document.getElementById('kpiYds').innerText = totYds.toLocaleString();
        document.getElementById('kpiRev').innerText = '$' + (totRev/1000000).toFixed(2) + 'M';
        document.getElementById('kpiLate').innerText = '$' + lateVal.toLocaleString();

        // CHARTS
        if(CHARTS.load) CHARTS.load.destroy();
        if(CHARTS.rev) CHARTS.rev.destroy();

        const machLoad = {};
        const revData = {};
        SCHEDULE.forEach(r => {
            [r.card, r.fin, r.qc].forEach(t => {
                if(t.mach && t.mach!=='Err') machLoad[t.mach] = (machLoad[t.mach]||0) + r.qty;
            });
            const m = new Date(r.globalEnd).toLocaleString('default',{month:'short'});
            revData[m] = (revData[m]||0) + r.val;
        });

        CHARTS.load = new Chart(document.getElementById('chartLoad'), {
            type: 'bar',
            data: { labels: Object.keys(machLoad), datasets: [{ label: 'Yards', data: Object.values(machLoad), backgroundColor: '#3b82f6' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });

        CHARTS.rev = new Chart(document.getElementById('chartRev'), {
            type: 'line',
            data: { labels: Object.keys(revData), datasets: [{ label: 'Revenue', data: Object.values(revData), borderColor: '#22c55e', fill: true, backgroundColor:'rgba(34,197,94,0.1)' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // --- HELPERS & DOWNTIME FIXED ---
    async function addDowntime() {
        if(USER_ROLE !== 'admin') return alert('Admin only');
        const m = document.getElementById('dtMachine').value;
        const s = document.getElementById('dtStart').value;
        const e = document.getElementById('dtEnd').value;
        if (!m || !s || !e) return;

        // OPTIMISTIC UPDATE: Update local state immediately
        const newEntry = {
            id: 'temp-' + Date.now(),
            machine: m,
            start: new Date(s).getTime(),
            end: new Date(e).getTime(),
            reason: 'Planned'
        };

        // Try DB save, but don't block
        try {
            const { data, error } = await sb.from('downtime').insert({
                machine: m, start_time: s, end_time: e, reason: 'Planned'
            }).select().single();
            
            if(!error && data) {
                newEntry.id = data.id; // Update with real ID
            }
        } catch(err) {
            console.warn("DB Save failed, using local session state only");
        }

        DOWNTIME.push(newEntry);
        renderDowntimeTable();
        runEngine();
    }

    function renderDowntimeTable() {
        const tb = document.getElementById('dtBody');
        tb.innerHTML = DOWNTIME.map((d, i) => `
            <tr class="border-b border-slate-100">
                <td class="p-4 font-bold text-slate-700">${d.machine}</td>
                <td class="p-4 text-slate-500">${new Date(d.start).toLocaleString()}</td>
                <td class="p-4 text-slate-500">${new Date(d.end).toLocaleString()}</td>
                <td class="p-4 text-slate-500 italic">${d.reason}</td>
                <td class="p-4 text-center"><button class="text-red-500 hover:text-red-700 admin-only" onclick="remDT(${i})"><i class="fa-solid fa-trash"></i></button></td>
            </tr>
        `).join('');
    }

    async function remDT(i) {
        if(USER_ROLE !== 'admin') return alert('Admin only');
        DOWNTIME.splice(i, 1);
        renderDowntimeTable();
        runEngine();
    }

    function runEngine() {
        if(!RAW_ORDERS.length) return;
        document.getElementById('engineStatus').innerText = "SOLVING...";
        document.getElementById('engineStatus').className = "text-yellow-600 animate-pulse";
        
        const simStart = document.getElementById('simDate').valueAsDate 
            ? document.getElementById('simDate').valueAsDate.getTime() 
            : new Date().setHours(8,0,0,0);

       const activeOrders = RAW_ORDERS.filter(o => 
            !String(o.status).toUpperCase().includes('SHIPPED')
    // We removed '&& o.rtsDate >= simStart' so it includes the backlog
);

        WORKER.postMessage({
            orders: activeOrders,
            rates: RATES,
            config: CONFIG,
            downtime: DOWNTIME,
            simStart: simStart,
            routes: ROUTES,
            staffing: STAFFING,
            overrides: OVERRIDES
        });
    }

    function renderStaffingTable() {
        const tb = document.getElementById('staffingTableBody');
        tb.innerHTML = '';
        CONFIG.machines.forEach(m => {
            const s = STAFFING[m];
            tb.innerHTML += `
                <tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="p-4 font-bold text-slate-700">${m}</td>
                    <td class="p-4 text-center"><input type="checkbox" ${s[0]?'checked':''} onchange="updateStaffing('${m}', 0, this.checked)" class="w-5 h-5 text-blue-600 rounded"></td>
                    <td class="p-4 text-center"><input type="checkbox" ${s[1]?'checked':''} onchange="updateStaffing('${m}', 1, this.checked)" class="w-5 h-5 text-blue-600 rounded"></td>
                    <td class="p-4 text-center"><input type="checkbox" ${s[2]?'checked':''} onchange="updateStaffing('${m}', 2, this.checked)" class="w-5 h-5 text-blue-600 rounded"></td>
                </tr>
            `;
        });
    }
    function updateStaffing(m, i, v) { STAFFING[m][i] = v; }
    function switchView(view) {
        document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById('view-'+view).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('nav-'+view).classList.add('active');
        if(view==='kpi') renderKPIs();
    }
    function showModal(id) { 
        if(id !== 'uploadModal' && USER_ROLE !== 'admin') return alert("Admin only"); 
        document.getElementById(id).style.display = 'flex'; 
    }
    function changeZoom(d) { ZOOM_PX = Math.max(20, Math.min(200, ZOOM_PX + d)); renderAll(); }
    function showTooltip(e, txt) {
        const tt = document.getElementById('tooltip');
        tt.style.display = 'block';
        tt.style.left = e.pageX + 10 + 'px';
        tt.style.top = e.pageY + 10 + 'px';
        tt.innerText = txt;
    }
    
    // COMMENTED OUT TO FIX SCROLLING CONFLICTS
    /*
    const g = document.getElementById('ganttChart');
    let isDown=false, startX, scrollLeft;
    g.addEventListener('mousedown',e=>{isDown=true;startX=e.pageX-g.offsetLeft;scrollLeft=g.scrollLeft;});
    g.addEventListener('mouseleave',()=>isDown=false);
    g.addEventListener('mouseup',()=>isDown=false);
    g.addEventListener('mousemove',e=>{if(!isDown)return;e.preventDefault();const x=e.pageX-g.offsetLeft;const walk=(x-startX)*2;g.scrollLeft=scrollLeft-walk;});
    */
</script>
</body>
</html>

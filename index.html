<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alkegen Scheduler v6.1 (Stable Engine + Features)</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    /* CORE VARIABLES & RESET */
    :root { --bg-light: #f8fafc; --panel-light: #ffffff; --border-light: #e2e8f0; --text-dark: #1e293b; --accent: #2563eb; }
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: var(--bg-light); color: var(--text-dark); overflow: hidden; margin: 0; }
    
    /* SCROLLBARS */
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: var(--bg-light); }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; border: 2px solid var(--bg-light); }
    
    /* AUTH STYLES */
    .app-container { display: flex; flex-direction: column; height: 100vh; }
    .hidden { display: none !important; }
    
    .login-wrapper { position: fixed; inset: 0; background: #f1f5f9; z-index: 9000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); width: 100%; max-width: 400px; border: 1px solid #e2e8f0; }

    /* ADMIN TOGGLES */
    .admin-only { display: none !important; }
    body.is-admin .admin-only { display: inline-flex !important; }
    
    /* APP STRUCTURE */
    header { background: var(--panel-light); border-bottom: 1px solid var(--border-light); padding: 0 1.5rem; height: 64px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; z-index: 50; }
    .nav-group { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; border: 1px solid var(--border-light); }
    .nav-btn { padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; color: #64748b; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
    .nav-btn:hover { color: var(--text-dark); background: white; shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .nav-btn.active { background: white; color: var(--accent); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    /* GANTT LAYOUT */
    .gantt-wrapper { display: flex; flex: 1; overflow: hidden; position: relative; background: #f8fafc; }
    .gantt-scroll-container { display: flex; flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; }
    .gantt-sidebar { width: 550px; background: white; border-right: 1px solid var(--border-light); display: flex; flex-direction: column; flex-shrink: 0; z-index: 20; position: sticky; left: 0; }
    .gantt-chart { flex: 1; position: relative; overflow-x: auto; overflow-y: visible; cursor: grab; user-select: none; background: white; }
    
    /* TABLES */
    .data-table { width: 100%; border-collapse: collapse; font-size: 11px; table-layout: fixed; }
    .gantt-header-row { position: sticky; top: 0; z-index: 40; display: flex; width: 100%; background: var(--bg-light); border-bottom: 1px solid var(--border-light); }
    .sidebar-header { width: 550px; flex-shrink: 0; background: #f1f5f9; border-right: 1px solid var(--border-light); z-index: 41; }
    .timeline-header-wrapper { flex: 1; overflow: hidden; position: relative; background: #f8fafc; }
    .data-table th { background: #f1f5f9; color: #475569; text-align: left; padding: 12px 8px; border-bottom: 1px solid var(--border-light); font-weight: 700; text-transform: uppercase; height: 60px; box-sizing: border-box; }
    .data-table td { padding: 0 8px; border-bottom: 1px solid #f1f5f9; color: #334155; height: 40px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
    .data-table tr:hover { background: #f0f9ff; }
    
    /* TIMELINE */
    .timeline-header { height: 60px; display: flex; }
    .day-col { flex-shrink: 0; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 10px; color: #64748b; position: relative; background: white; height: 100%; }
    .day-col.weekend { background: #f8fafc; }
    
    /* BARS */
    .chart-row { height: 40px; border-bottom: 1px dashed #e2e8f0; position: relative; width: 100%; }
    .bar { position: absolute; height: 24px; top: 8px; border-radius: 4px; font-size: 9px; font-weight: 600; color: white; display: flex; align-items: center; padding-left: 4px; overflow: hidden; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 10; border: 1px solid rgba(255,255,255,0.2); transition: all 0.1s; }
    .bar:hover { z-index: 50; transform: scale(1.02); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); }
    
    /* Dynamic Colors */
    .bar-card { background: #3b82f6; border-left: 3px solid #93c5fd; }
    .bar-fin { background: #8b5cf6; border-left: 3px solid #c4b5fd; }
    .bar-qc { background: #f97316; border-left: 3px solid #fdba74; }
    .bar-forced { border: 2px solid #ef4444; }

    /* UTILS */
    .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 1000; display: none; align-items: center; justify-content: center; }
    .modal-content { background: white; border: 1px solid var(--border-light); border-radius: 12px; padding: 24px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-height: 80vh; overflow-y: auto; }
    .tooltip { position: fixed; background: #1e293b; color: white; padding: 8px 12px; border-radius: 6px; font-size: 11px; z-index: 2000; pointer-events: none; display: none; }
    .late-row { background-color: #fef2f2 !important; }
    .late-text { color: #dc2626 !important; font-weight: bold; }
    .override-text { color: #d97706; font-weight: bold; }

    /* DIGITAL TWIN STYLES */
    canvas#simCanvas { border: 1px solid #e2e8f0; background: #fafafa; width: 100%; height: 350px; border-radius: 8px; }
    .dt-control-group { margin-bottom: 12px; border-bottom: 1px solid #f1f5f9; padding-bottom: 12px; }
    .dt-label { font-size: 10px; text-transform: uppercase; color: #64748b; font-weight: 700; display: block; margin-bottom: 4px; }
    .dt-val { font-family: monospace; font-weight: bold; color: #2563eb; font-size: 11px; float: right; }
    
    /* RETROFIT STYLES ADAPTED */
    .kpi-card-retro { background: white; border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px; position: relative; overflow: hidden; }
    .kpi-card-retro::before { content:''; position:absolute; top:0; left:0; width:4px; height:100%; background: #2563eb; }
    .bar-group-retro { display: flex; flex-direction: column; justify-content: flex-end; flex: 1; height: 100%; position: relative; }
    .bar-retro { width: 100%; border-radius: 4px 4px 0 0; transition: height 0.5s; min-height: 4px; }
  </style>
</head>
<body>

<div id="loginScreen" class="login-wrapper">
    <div class="mb-8 text-center">
        <div class="w-16 h-16 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg mx-auto mb-4">
            <i class="fa-solid fa-industry text-white text-2xl"></i>
        </div>
        <h1 class="text-2xl font-bold text-slate-800">Alkegen Scheduler</h1>
        <p class="text-slate-500 text-sm">Secure Production System</p>
    </div>
    <div class="login-box">
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label>
                <input type="email" id="email" class="w-full border border-slate-300 rounded p-2 text-sm" placeholder="email@alkegen.com">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                <input type="password" id="password" class="w-full border border-slate-300 rounded p-2 text-sm" placeholder="••••••••">
            </div>
            <button onclick="handleLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded transition shadow-md">Sign In</button>
            <p id="loginError" class="text-red-500 text-xs text-center hidden"></p>
        </div>
    </div>
</div>

<div id="mainApp" class="app-container hidden">
    <header>
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center shadow-md">
                <i class="fa-solid fa-industry text-white"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg text-slate-800 leading-tight">Alkegen <span class="text-blue-600">Production</span></h1>
                <div class="flex items-center gap-2 text-xs text-slate-500 font-medium">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span> <span id="userRoleBadge">Viewer</span> Mode
                    <span class="ml-2 px-1.5 py-0.5 bg-slate-100 border border-slate-200 rounded text-[9px] font-mono text-slate-400">v6.1 (Stable Engine)</span>
                </div>
            </div>
        </div>

        <nav class="nav-group">
            <button onclick="switchView('gantt')" id="nav-gantt" class="nav-btn active"><i class="fa-solid fa-layer-group"></i>Schedule</button>
            <button onclick="switchView('sequencing')" id="nav-sequencing" class="nav-btn"><i class="fa-solid fa-route"></i>Sequencing</button>
            <button onclick="switchView('rates')" id="nav-rates" class="nav-btn"><i class="fa-solid fa-sliders"></i>Rates</button>
            <button onclick="switchView('twin')" id="nav-twin" class="nav-btn text-blue-600 bg-blue-50"><i class="fa-solid fa-microchip"></i>Digital Twin</button>
            <button onclick="switchView('capex')" id="nav-capex" class="nav-btn text-green-600 bg-green-50"><i class="fa-solid fa-leaf"></i>ESG & CapEx</button>
            <button onclick="switchView('kpi')" id="nav-kpi" class="nav-btn"><i class="fa-solid fa-chart-pie"></i>Analytics</button>
            <button onclick="switchView('downtime')" id="nav-downtime" class="nav-btn"><i class="fa-solid fa-triangle-exclamation"></i>Downtime</button>
        </nav>

        <div class="flex items-center gap-3">
            <span id="userEmailDisplay" class="text-xs text-slate-400 mr-2 font-mono"></span>
            <button onclick="showModal('uploadModal')" class="admin-only px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold rounded-lg shadow-sm transition flex items-center gap-2">
                <i class="fa-solid fa-cloud-arrow-up"></i> Import
            </button>
            <button onclick="exportExcel()" class="w-9 h-9 flex items-center justify-center text-green-600 hover:bg-green-50 rounded-lg border border-green-200 transition" title="Export Excel">
                <i class="fa-solid fa-file-excel text-lg"></i>
            </button>
            <button onclick="handleLogout()" class="w-9 h-9 flex items-center justify-center text-slate-400 hover:bg-slate-100 rounded-lg border border-slate-200 transition" title="Logout">
                <i class="fa-solid fa-right-from-bracket"></i>
            </button>
        </div>
    </header>

    <div id="view-gantt" class="flex-1 flex flex-col relative fade-in overflow-hidden">
        <div class="h-14 border-b border-slate-200 bg-white flex items-center justify-between px-6 flex-shrink-0 z-40">
            <div class="flex items-center gap-6">
                <div class="flex flex-col">
                    <label class="text-[10px] uppercase font-bold text-slate-500 tracking-wider">Start Date</label>
                    <input type="date" id="simDate" class="text-xs border-none bg-transparent font-bold text-slate-700 p-0 focus:ring-0 cursor-pointer hover:text-blue-600 transition" onchange="runEngine()">
                </div>
                <div class="h-8 w-px bg-slate-200"></div>
                <div class="flex items-center gap-3 group relative">
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="campaignMode" class="sr-only peer" checked onchange="runEngine()">
                        <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                        <span class="ml-2 text-xs font-bold text-slate-600 group-hover:text-slate-900 transition">Campaign Mode</span>
                    </label>
                </div>
                <div class="h-8 w-px bg-slate-200"></div>
                <div class="text-xs font-mono">
                    <span class="text-slate-500">ENGINE: </span>
                    <span id="engineStatus" class="text-green-600 font-bold">READY</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center bg-slate-100 rounded-lg p-1 border border-slate-200">
                    <button onclick="changeZoom(-10)" class="w-7 h-7 flex items-center justify-center text-slate-500 hover:text-blue-600 hover:bg-white rounded transition"><i class="fa-solid fa-minus"></i></button>
                    <span class="px-2 text-xs font-mono text-slate-500 select-none">ZOOM</span>
                    <button onclick="changeZoom(10)" class="w-7 h-7 flex items-center justify-center text-slate-500 hover:text-blue-600 hover:bg-white rounded transition"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
        </div>

        <div class="gantt-header-row">
            <div class="sidebar-header">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 80px">Status</th>
                            <th style="width: 90px">Order</th>
                            <th style="width: 130px">Felt Code</th>
                            <th style="width: 100px">Card</th>
                            <th style="width: 100px">Fin</th>
                            <th style="width: 50px; text-align: right">Bal</th>
                        </tr>
                    </thead>
                </table>
            </div>
            <div class="timeline-header-wrapper" id="timelineHeaderWrapper">
                <div id="timelineHeader" class="timeline-header"></div>
            </div>
        </div>

        <div class="gantt-wrapper">
            <div class="gantt-scroll-container" id="mainScroll">
                <div class="gantt-sidebar">
                    <table class="data-table">
                        <tbody id="taskTableBody"></tbody>
                    </table>
                </div>
                <div class="gantt-chart" id="ganttChart">
                    <div id="todayLine" style="position: absolute; top: 0; bottom: 0; width: 1px; background: #ef4444; z-index: 40; pointer-events: none; border-left: 1px dashed #ef4444;"></div>
                    <div id="timelineBody" class="pb-24"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-twin" class="flex-1 hidden bg-white p-6 fade-in overflow-auto">
        <div class="max-w-7xl mx-auto h-full flex flex-col">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Stochastic Digital Twin</h2>
                    <p class="text-sm text-slate-500">Simulate production variance on a specific line configuration.</p>
                </div>
                <div class="flex gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Target Felt Code</label>
                        <select id="dtFeltSelect" class="bg-white border border-slate-300 rounded p-2 text-sm w-48" onchange="initDigitalTwin()"></select>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-12 gap-6 flex-grow">
                <div class="col-span-3 bg-white border border-slate-200 rounded-xl p-5 shadow-sm overflow-y-auto h-full">
                    <h3 class="font-bold text-slate-700 border-b border-slate-100 pb-2 mb-4">Parameters</h3>
                    
                    <div class="dt-control-group">
                        <div class="text-xs font-bold text-blue-600 mb-2">STATION 1: CARDING</div>
                        <span class="dt-label">Avg Cycle Time (sec/yd) <span id="v_ct1" class="dt-val">--</span></span>
                        <input type="range" min="1.0" max="30.0" step="0.1" class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="updateDTParam(0, 'mean', this.value)" id="i_ct1">
                        <span class="dt-label mt-2">Variance (Sigma) <span id="v_sig1" class="dt-val">0.5</span></span>
                        <input type="range" min="0.0" max="5.0" step="0.1" value="0.5" class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="updateDTParam(0, 'sigma', this.value)">
                    </div>

                    <div class="dt-control-group">
                        <div class="text-xs font-bold text-purple-600 mb-2">STATION 2: FINISHING</div>
                        <span class="dt-label">Avg Cycle Time (sec/yd) <span id="v_ct2" class="dt-val">--</span></span>
                        <input type="range" min="1.0" max="30.0" step="0.1" class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="updateDTParam(1, 'mean', this.value)" id="i_ct2">
                        <span class="dt-label mt-2">Variance (Sigma) <span id="v_sig2" class="dt-val">1.5</span></span>
                        <input type="range" min="0.0" max="5.0" step="0.1" value="1.5" class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="updateDTParam(1, 'sigma', this.value)">
                    </div>

                    <div class="dt-control-group">
                        <div class="text-xs font-bold text-orange-600 mb-2">STATION 3: QC</div>
                        <span class="dt-label">Avg Cycle Time (sec/yd) <span id="v_ct3" class="dt-val">--</span></span>
                        <input type="range" min="1.0" max="30.0" step="0.1" class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="updateDTParam(2, 'mean', this.value)" id="i_ct3">
                        <span class="dt-label mt-2">Variance (Sigma) <span id="v_sig3" class="dt-val">0.2</span></span>
                        <input type="range" min="0.0" max="5.0" step="0.1" value="0.2" class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="updateDTParam(2, 'sigma', this.value)">
                    </div>

                    <div class="mt-4 flex gap-2">
                        <button onclick="toggleSim()" id="btnToggleSim" class="flex-1 bg-blue-600 text-white font-bold py-2 rounded text-xs hover:bg-blue-700">PAUSE</button>
                        <button onclick="resetSim()" class="flex-1 bg-slate-100 text-slate-600 font-bold py-2 rounded text-xs hover:bg-slate-200">RESET</button>
                    </div>
                </div>

                <div class="col-span-9 flex flex-col gap-4">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-white border border-slate-200 p-4 rounded-xl shadow-sm text-center">
                            <div class="text-xs text-slate-500 uppercase font-bold">Throughput</div>
                            <div class="text-2xl font-bold text-slate-800" id="dispDTThroughput">0</div>
                            <div class="text-[10px] text-slate-400">Units / Hour</div>
                        </div>
                        <div class="bg-white border border-slate-200 p-4 rounded-xl shadow-sm text-center">
                            <div class="text-xs text-slate-500 uppercase font-bold">System OEE</div>
                            <div class="text-2xl font-bold text-blue-600" id="dispDTOEE">0%</div>
                            <div class="text-[10px] text-slate-400">Efficiency</div>
                        </div>
                        <div class="bg-white border border-slate-200 p-4 rounded-xl shadow-sm text-center">
                            <div class="text-xs text-slate-500 uppercase font-bold">WIP (Buffer)</div>
                            <div class="text-2xl font-bold text-orange-500" id="dispDTWIP">0</div>
                            <div class="text-[10px] text-slate-400">Items Queued</div>
                        </div>
                    </div>

                    <div class="flex-grow bg-white border border-slate-200 rounded-xl shadow-sm p-4 flex flex-col">
                        <canvas id="simCanvas"></canvas>
                        <div class="flex justify-between items-start mt-4 px-2">
                            <div class="text-xs text-slate-500 flex gap-4">
                                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-600"></span> Running</span>
                                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-amber-400"></span> Starved</span>
                                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> Blocked</span>
                            </div>
                            <div class="text-xs font-mono text-right">
                                <div>Theoretical Max: <span id="theoMax">--</span></div>
                                <div class="text-red-500">Starvation Loss: <span id="starveLoss">--</span></div>
                                <div class="text-red-500">Blocking Loss: <span id="blockLoss">--</span></div>
                            </div>
                        </div>
                        <div id="textInsight" class="mt-3 p-3 bg-slate-50 rounded border border-slate-100 text-xs text-slate-600 italic">
                            Initializing analysis...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-capex" class="flex-1 hidden bg-white p-8 fade-in overflow-auto">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Retrofit Impact Modeler</h2>
            <p class="text-sm text-slate-500 mb-8">Model ROI and Carbon impact for equipment upgrades based on current production volume.</p>

            <div class="grid grid-cols-12 gap-8">
                <div class="col-span-4 space-y-6">
                    <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                        <h3 class="text-sm font-bold text-slate-700 uppercase mb-4 border-b border-slate-200 pb-2">Current State</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Annual Energy (kWh)</label>
                                <div class="relative">
                                    <input type="number" id="baseEnergy" class="w-full border border-slate-300 rounded p-2 text-sm pl-3 pr-8" oninput="calcCapex()">
                                    <span class="absolute right-3 top-2 text-xs text-slate-400">kWh</span>
                                </div>
                                <p class="text-[10px] text-blue-500 mt-1 cursor-pointer hover:underline" onclick="estimateEnergy()">* Estimate from Schedule Output</p>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Energy Cost ($/kWh)</label>
                                <div class="relative">
                                    <input type="number" id="energyCost" value="0.12" step="0.01" class="w-full border border-slate-300 rounded p-2 text-sm" oninput="calcCapex()">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Grid Carbon (kgCO2/kWh)</label>
                                <div class="relative">
                                    <input type="number" id="carbonIntensity" value="0.38" step="0.01" class="w-full border border-slate-300 rounded p-2 text-sm" oninput="calcCapex()">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-sm font-bold text-slate-700 uppercase mb-4 border-b border-slate-100 pb-2">Retrofit Project</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Total CAPEX ($)</label>
                                <input type="number" id="capexVal" value="150000" class="w-full border border-slate-300 rounded p-2 text-sm" oninput="calcCapex()">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Efficiency Gain (%)</label>
                                <input type="number" id="effGain" value="35" class="w-full border border-slate-300 rounded p-2 text-sm" oninput="calcCapex()">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-span-8 space-y-6">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="kpi-card-retro">
                            <div class="text-xs font-bold text-slate-400 uppercase">Annual Savings</div>
                            <div class="text-2xl font-bold text-teal-600 mt-1" id="dispSavings">$0</div>
                            <div class="text-xs text-slate-400 mt-1">Energy Only</div>
                        </div>
                        <div class="kpi-card-retro">
                            <div class="text-xs font-bold text-slate-400 uppercase">Payback Period</div>
                            <div class="text-2xl font-bold text-slate-700 mt-1" id="dispPayback">0.0 Yrs</div>
                            <div class="text-xs text-slate-400 mt-1">ROI: <span id="dispROI">0%</span></div>
                        </div>
                        <div class="kpi-card-retro">
                            <div class="text-xs font-bold text-slate-400 uppercase">Carbon Removed</div>
                            <div class="text-2xl font-bold text-green-600 mt-1" id="dispCarbon">0</div>
                            <div class="text-xs text-slate-400 mt-1">Tonnes CO2e / Year</div>
                        </div>
                    </div>

                    <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm flex flex-col h-80">
                        <h3 class="text-sm font-bold text-slate-700 mb-6">10-Year Financial Projection</h3>
                        <div class="flex gap-12 items-end flex-1 pb-4 border-b border-slate-100 relative">
                             <div class="bar-group-retro">
                                <div class="text-center text-xs font-mono font-bold text-slate-700 mb-2" id="valOldCost">$0</div>
                                <div class="bar-retro bg-slate-300" id="barOldCost" style="height: 80%;"></div>
                                <div class="text-center text-xs text-slate-500 mt-2">Current OpEx</div>
                            </div>
                            <div class="bar-group-retro">
                                <div class="text-center text-xs font-mono font-bold text-slate-700 mb-2" id="valNewCost">$0</div>
                                <div class="bar-retro bg-teal-400" id="barNewCost" style="height: 50%;"></div>
                                <div class="text-center text-xs text-slate-500 mt-2">Post-Retrofit OpEx</div>
                            </div>
                            <div class="bar-group-retro">
                                <div class="text-center text-xs font-mono font-bold text-green-700 mb-2" id="valCumSavings">$0</div>
                                <div class="bar-retro bg-green-500" id="barCumSavings" style="height: 90%;"></div>
                                <div class="text-center text-xs text-slate-500 mt-2">10-Yr Net Benefit</div>
                            </div>
                        </div>
                        <div id="analysisText" class="mt-4 text-xs text-teal-700 bg-teal-50 p-3 rounded border border-teal-100">
                            Loading analysis...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-sequencing" class="flex-1 hidden bg-white p-8 fade-in overflow-auto">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Machine Preferences</h2>
            <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200">
                        <tr><th class="p-4">Felt Code</th><th class="p-4">Carding</th><th class="p-4">Finishing</th><th class="p-4">QC</th><th class="p-4 text-center">Action</th></tr>
                    </thead>
                    <tbody id="sequencingTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-rates" class="flex-1 hidden bg-white p-8 fade-in overflow-auto">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Rates & Changeovers</h2>
            <div class="bg-white rounded-lg border border-slate-200 overflow-hidden shadow-sm">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200">
                        <tr><th class="p-4 w-1/3">Felt Code</th><th class="p-4 text-right">Carding (yds/hr)</th><th class="p-4 text-right">Finishing (yds/hr)</th><th class="p-4 text-right">QC (yds/hr)</th></tr>
                    </thead>
                    <tbody id="ratesTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-kpi" class="flex-1 hidden bg-white p-8 fade-in overflow-auto">
        <div class="max-w-7xl mx-auto space-y-8">
            <h2 class="text-2xl font-bold text-slate-800">Operational Analytics</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><div class="text-xs font-bold text-slate-400 uppercase">Throughput</div><div class="text-3xl font-bold text-slate-800 mt-2" id="kpiYds">0</div></div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><div class="text-xs font-bold text-slate-400 uppercase">Revenue</div><div class="text-3xl font-bold text-green-600 mt-2" id="kpiRev">$0</div></div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><div class="text-xs font-bold text-slate-400 uppercase">Late Value</div><div class="text-3xl font-bold text-red-600 mt-2" id="kpiLate">$0</div></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-96">
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col"><div class="flex-grow relative"><canvas id="chartLoad"></canvas></div></div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col"><div class="flex-grow relative"><canvas id="chartRev"></canvas></div></div>
            </div>
        </div>
    </div>

     <div id="view-downtime" class="flex-1 hidden bg-white p-8 fade-in overflow-auto">
         <div class="max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Planned Downtime</h2>
            <div class="bg-white p-6 rounded-xl border border-slate-200 mb-8 shadow-sm grid grid-cols-1 md:grid-cols-4 gap-4 items-end admin-only">
                <select id="dtMachine" class="w-full bg-slate-50 border border-slate-300 rounded p-2 text-sm"></select>
                <input type="datetime-local" id="dtStart" class="w-full bg-slate-50 border border-slate-300 rounded p-2 text-sm">
                <input type="datetime-local" id="dtEnd" class="w-full bg-slate-50 border border-slate-300 rounded p-2 text-sm">
                <button onclick="addDowntime()" class="bg-red-600 text-white font-bold py-2 rounded text-sm shadow">Add Block</button>
            </div>
            <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                <table class="w-full text-sm text-left text-slate-600"><tbody id="dtBody" class="divide-y divide-slate-100"></tbody></table>
            </div>
        </div>
    </div>
</div>

<div id="uploadModal" class="modal-bg">
    <div class="modal-content">
        <h2 class="text-xl font-bold mb-6 text-slate-800 border-b border-slate-200 pb-2">Import Data</h2>
        <div class="space-y-4">
            <div class="border border-dashed border-slate-300 rounded-lg p-6 hover:bg-slate-50 relative text-center">
                <div class="font-bold text-slate-700">1. Load Rates</div>
                <div class="text-xs text-slate-500" id="rateStatus">Rates.xlsx</div>
                <input type="file" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleRateUpload(this)">
            </div>
            <div class="border border-dashed border-slate-300 rounded-lg p-6 hover:bg-slate-50 relative text-center">
                <div class="font-bold text-slate-700">2. Load Orders</div>
                <div class="text-xs text-slate-500" id="orderStatus">Open Orders.xlsx</div>
                <input type="file" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleOrderUpload(this)">
            </div>
            <div class="border border-dashed border-slate-300 rounded-lg p-6 hover:bg-slate-50 relative text-center">
                <div class="font-bold text-slate-700">3. Load Digital Schedule</div>
                <div class="text-xs text-slate-500" id="routeStatus">Digital Schedule.xlsx</div>
                <input type="file" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleRouteUpload(this)">
            </div>
        </div>
        <div class="flex justify-end gap-3 mt-8">
            <button onclick="document.getElementById('uploadModal').style.display='none'" class="px-4 py-2 text-slate-500 font-bold text-sm">Cancel</button>
            <button onclick="runEngine()" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-lg">Initialize</button>
        </div>
    </div>
</div>

<div id="editOrderModal" class="modal-bg">
    <div class="modal-content w-[500px]">
        <h2 class="text-lg font-bold text-slate-800 mb-4">Edit Order <span id="editOrderId" class="text-blue-600"></span></h2>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Balance</label><input type="number" id="editQty" class="w-full bg-white border border-slate-300 rounded p-2 text-sm"></div>
            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Felt</label><input type="text" id="editFelt" class="w-full bg-gray-100 border border-slate-300 rounded p-2 text-sm" readonly></div>
        </div>
        <div class="border-t border-slate-200 pt-4 mb-4">
            <h3 class="text-xs font-bold text-slate-800 mb-2 uppercase">Force Override</h3>
            <div class="grid grid-cols-3 gap-3">
                <select id="forceCard" class="w-full bg-white border border-slate-300 rounded p-2 text-xs"><option value="">Auto</option></select>
                <select id="forceFin" class="w-full bg-white border border-slate-300 rounded p-2 text-xs"><option value="">Auto</option></select>
                <select id="forceQC" class="w-full bg-white border border-slate-300 rounded p-2 text-xs"><option value="">Auto</option></select>
            </div>
        </div>
        <div class="mt-6 flex justify-end gap-3">
            <button onclick="document.getElementById('editOrderModal').style.display='none'" class="px-4 py-2 text-slate-500 font-bold text-sm">Cancel</button>
            <button onclick="saveOrderEdit()" class="admin-only px-4 py-2 bg-blue-600 text-white font-bold rounded shadow">Save</button>
        </div>
    </div>
</div>

<div id="tooltip" class="tooltip"></div>

<script id="worker-script" type="javascript/worker">
    self.onmessage = function(e) {
        const { orders, rates, config, downtime, simStart, routes, staffing, overrides } = e.data;
        const MACHINES = config.machines;
        
        let schedule = [];
        let now = simStart || new Date().getTime();
        let machineState = {};
        let activeDowntime = [...downtime];

        // 1. STAFFING DOWNTIME
        for(let d=0; d<60; d++) {
            const dayStart = now + (d * 86400000);
            const midnight = new Date(dayStart).setHours(0,0,0,0);
            Object.keys(staffing).forEach(machName => {
                const avail = staffing[machName];
                if(!avail) return;
                if(!avail[0]) activeDowntime.push({ machine: machName, start: midnight + (8*3600000), end: midnight + (16*3600000), reason: 'Staffing' });
                if(!avail[1]) activeDowntime.push({ machine: machName, start: midnight + (16*3600000), end: midnight + (24*3600000), reason: 'Staffing' });
                if(!avail[2]) activeDowntime.push({ machine: machName, start: midnight, end: midnight + (8*3600000), reason: 'Staffing' });
            });
        }

        // Init State
        MACHINES.forEach(m => { machineState[m] = { time: now, lastFelt: null }; });

        // 2. CAMPAIGN SORT
        let queue = [...orders];
        if (config.campaign) {
            queue.sort((a,b) => {
                const dateA = a.rtsDate || 9999999999999;
                const dateB = b.rtsDate || 9999999999999;
                const weekA = Math.floor(dateA / (7 * 86400000));
                const weekB = Math.floor(dateB / (7 * 86400000));
                if (weekA !== weekB) return weekA - weekB;
                if (a.felt < b.felt) return -1;
                if (a.felt > b.felt) return 1;
                return dateA - dateB;
            });
        } else {
            queue.sort((a,b) => a.rtsDate - b.rtsDate);
        }

        // 3. SCHEDULER
        queue.forEach(ord => {
            const r = rates[ord.felt] || Object.values(rates)[0] || {card:250, finish:700, qc:400};
            
            // Preference List from Sheet 4 (or generic fallback)
            let prefs = routes[ord.felt] || {
                card: MACHINES.filter(m => m.includes('Card')),
                fin: MACHINES.filter(m => m.includes('Bruckner') || m.includes('Kusters') || m.includes('Singer') || m.includes('Dilo')),
                qc: MACHINES.filter(m => m.includes('QC'))
            };

            // USER OVERRIDES
            if(overrides[ord.id]) {
                if(overrides[ord.id].card) prefs.card = [overrides[ord.id].card];
                if(overrides[ord.id].fin) prefs.fin = [overrides[ord.id].fin];
                if(overrides[ord.id].qc) prefs.qc = [overrides[ord.id].qc];
            }

            // SMART ALLOCATION: Score machines based on fit
            // --- STEP 1: CARDING ---
            let cRes = allocateSmart(prefs.card, now, (ord.qty / (r.card||250)), ord.felt);
            
            // --- STEP 2: FINISHING ---
            let fReady = cRes.end + 3600000; // 1hr move
            let fRes = allocateSmart(prefs.fin, fReady, (ord.qty / (r.finish||700)), ord.felt);

            // --- STEP 3: QC ---
            let qReady = fRes.end + 1800000; // 30m move
            let qRes = allocateSmart(prefs.qc, qReady, (ord.qty / (r.qc||400)), ord.felt);

            schedule.push({
                ...ord,
                card: cRes, fin: fRes, qc: qRes,
                allMachs: [cRes.mach, fRes.mach, qRes.mach],
                globalEnd: qRes.end,
                isLate: qRes.end > ord.rtsDate
            });
        });

        // Helper: Scored Allocation (Look-Ahead Logic)
        function allocateSmart(pool, readyTime, durHrs, felt) {
            if(!pool || pool.length === 0) return { mach:'Err', start:readyTime, end:readyTime };
            
            const durMs = durHrs * 3600000;
            let candidates = [];

            pool.forEach(mName => {
                const mState = machineState[mName] || { time: now, lastFelt: null };
                let start = Math.max(mState.time, readyTime);
                let hasSetup = false;
                
                // Setup Penalty Logic
                if(mState.lastFelt && mState.lastFelt !== felt) {
                    start += (config.setupPenalty * 3600000);
                    hasSetup = true;
                }

                // Downtime Check
                let conflict = true;
                let attempts = 0;
                while(conflict && attempts < 50) {
                    conflict = false;
                    const potentialEnd = start + durMs;
                    const dt = activeDowntime.find(d => d.machine === mName && d.start < potentialEnd && d.end > start);
                    if (dt) {
                        start = dt.end;
                        conflict = true;
                    }
                    attempts++;
                }

                candidates.push({
                    mach: mName,
                    start: start,
                    end: start + durMs,
                    hasSetup: hasSetup
                });
            });

            // SCORING: 
            // 1. Prefer machines that are ALREADY SET UP for this felt (avoid changeover), 
            //    unless the delay is huge (> 4 hours).
            // 2. Otherwise pick earliest finish.
            
            candidates.sort((a,b) => {
                const delayA = a.end;
                const delayB = b.end;
                
                // If A has setup and B doesn't, favor B heavily unless B is way later
                if (a.hasSetup && !b.hasSetup) {
                    // If B is available within 4 hours of A, take B (avoid setup)
                    if (delayB < delayA + 14400000) return 1; 
                }
                if (!a.hasSetup && b.hasSetup) {
                    if (delayA < delayB + 14400000) return -1;
                }

                return delayA - delayB;
            });

            const best = candidates[0];

            if(best) {
                if(!machineState[best.mach]) machineState[best.mach] = { time: now, lastFelt: null };
                machineState[best.mach].time = best.end;
                machineState[best.mach].lastFelt = felt;
                return { mach: best.mach, start: best.start, end: best.end };
            }
            return { mach:'Err', start:readyTime, end:readyTime+durMs };
        }

        // 4. ANALYTICS
        let dayLoads = {};
        schedule.forEach(s => {
            [s.card, s.fin, s.qc].forEach(t => {
                if(t.start && t.end) {
                    const startDay = Math.floor(t.start / 86400000);
                    const endDay = Math.floor(t.end / 86400000);
                    for(let i=startDay; i<=endDay; i++) dayLoads[i] = (dayLoads[i]||0) + 1;
                }
            });
        });

        self.postMessage({ schedule, dayLoads });
    };
</script>

<script>
    // --- APP STATE & CONFIG ---
    const SB_URL = 'https://tihzqfpyfanohnazvkcx.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpaHpxZnB5ZmFub2huYXp2a2N4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NzY5MDAsImV4cCI6MjA4MDI1MjkwMH0.-ZbsX_CDTpNG3FRfH2KZcJjoj61z6JfHWQ7_cWyXAv0';
    const sb = supabase.createClient(SB_URL, SB_KEY);

    const CONFIG = {
        machines: ['Card 1','Card 2','Card 3','Card 4','Card 5','Card 6','Card 7','Card 8','Card 9',
                   'Bruckner 1','Bruckner 2','Kusters','Singer 1','Singer 2','Perkins','Hunter','Dilo',
                   'Fehrer 228', 'Heatset', 'Needleloom', // Added missing machines from v5.2 config
                   'QC 1','QC 2','QC 3','QC 4','QC 5','QC 6','QC 7','QC 8','QC Lab'], // Restored full list
        setupPenalty: 4, campaign: true
    };

    let RATES={}; let RAW_ORDERS=[]; let ROUTES={}; let OVERRIDES={}; let DOWNTIME=[]; let SCHEDULE=[]; let STAFFING={};
    let WORKER=null; let CHART_LOAD=null; let CHART_REV=null; let ZOOM_PX=60; let USER_ROLE='viewer';

    // --- MAIN INIT ---
    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if(error) document.getElementById('loginError').innerText = error.message;
        else initApp(data.user);
    }
    
    async function initApp(user) {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('userEmailDisplay').innerText = user.email;
        if(user.email.includes('admin')) USER_ROLE='admin';
        document.getElementById('userRoleBadge').innerText = USER_ROLE.toUpperCase();
        if(USER_ROLE==='admin') document.body.classList.add('is-admin');
        
        document.getElementById('simDate').valueAsDate = new Date();
        // Init Staffing Default
        CONFIG.machines.forEach(m => STAFFING[m] = [true, true, true]);
        
        initWorker();
        initDigitalTwinCanvas();
        populateDropdowns();
        try {
            const {data:rt} = await sb.from('rates').select('*');
            if(rt) rt.forEach(r => RATES[r.felt_code] = {card:r.card_rate, finish:r.finish_rate, qc:r.qc_rate});
        } catch(e) {}
    }

    function populateDropdowns() {
        ['dtMachine','forceCard','forceFin','forceQC'].forEach(id => {
            const el = document.getElementById(id); if(!el) return;
            CONFIG.machines.forEach(m => el.innerHTML += `<option value="${m}">${m}</option>`);
        });
    }

    function initWorker() {
        const blob = new Blob([document.getElementById('worker-script').textContent], {type: "text/javascript"});
        WORKER = new Worker(window.URL.createObjectURL(blob));
        WORKER.onmessage = (e) => {
            SCHEDULE = e.data.schedule;
            renderGantt(e.data.dayLoads);
            renderKPIs();
            updateFeltDropdown(); // for Twin
            document.getElementById('engineStatus').innerText = "ONLINE";
        };
    }

    function runEngine() {
        if(!RAW_ORDERS.length) return;
        document.getElementById('engineStatus').innerText = "SOLVING...";
        const simStart = document.getElementById('simDate').valueAsDate ? document.getElementById('simDate').valueAsDate.getTime() : new Date().setHours(8,0,0,0);
        
        // v5.2 Logic required filtering orders first
        const activeOrders = RAW_ORDERS.filter(o => !String(o.status).toUpperCase().includes('SHIPPED') && o.rtsDate >= simStart);

        WORKER.postMessage({ 
            orders:activeOrders, 
            rates:RATES, 
            config:CONFIG, 
            downtime:DOWNTIME, 
            simStart:simStart, 
            routes:ROUTES, 
            staffing:STAFFING, // Critical: pass staffing back in
            overrides:OVERRIDES 
        });
    }

    // --- GANTT & KPI RENDERING (Condensed) ---
    function renderGantt(dayLoads) {
        const tbody = document.getElementById('taskTableBody'); tbody.innerHTML='';
        const tlHead = document.getElementById('timelineHeader'); tlHead.innerHTML='';
        const tlBody = document.getElementById('timelineBody'); tlBody.innerHTML='';
        if(!SCHEDULE.length) return;
        
        const now = document.getElementById('simDate').valueAsDate.getTime();
        const maxEnd = Math.max(...SCHEDULE.map(d=>d.globalEnd));
        const totalDays = Math.ceil((maxEnd-now)/86400000)+5;
        const width = totalDays * ZOOM_PX;
        document.getElementById('timelineHeaderWrapper').firstChild.style.width = width+'px';

        for(let i=0; i<totalDays; i++) {
            const d = new Date(now + i*86400000);
            const load = dayLoads[Math.floor(d.getTime()/86400000)] || 0;
            const bg = load > 150 ? 'bg-red-400' : (load > 50 ? 'bg-amber-300' : 'bg-green-400');
            tlHead.innerHTML += `<div class="day-col" style="width:${ZOOM_PX}px"><span class="mt-2 font-bold">${d.getDate()}</span><div class="absolute bottom-0 w-full h-1 ${bg} opacity-50"></div></div>`;
        }

        SCHEDULE.forEach(r => {
            tbody.innerHTML += `<tr><td><span class="inline-block w-2 h-2 rounded-full mr-2 ${r.isLate?'bg-red-500':'bg-green-500'}"></span>${r.status||'New'}</td><td class="font-mono text-xs hover:text-blue-600 cursor-pointer" onclick="openEdit('${r.id}')">${r.id}</td><td class="font-bold text-blue-600 text-xs">${r.felt}</td><td class="text-[10px] text-slate-500">${r.card.mach}</td><td class="text-[10px] text-slate-500">${r.fin.mach}</td><td class="text-right text-xs font-mono">${r.qty}</td></tr>`;
            
            const rowDiv = document.createElement('div'); rowDiv.className='chart-row'; rowDiv.style.width=width+'px';
            [r.card, r.fin, r.qc].forEach((t, i) => {
                if(t.mach==='Err') return;
                const left = ((t.start-now)/86400000)*ZOOM_PX;
                const w = Math.max(((t.end-t.start)/86400000)*ZOOM_PX, 2);
                const cls = i===0?'bar-card':(i===1?'bar-fin':'bar-qc');
                rowDiv.innerHTML += `<div class="bar ${cls}" style="left:${left}px; width:${w}px">${t.mach}</div>`;
            });
            tlBody.appendChild(rowDiv);
        });
    }

    function renderKPIs() {
        const totYds = SCHEDULE.reduce((a,b)=>a+b.qty,0);
        const totRev = SCHEDULE.reduce((a,b)=>a+b.val,0);
        document.getElementById('kpiYds').innerText = totYds.toLocaleString();
        document.getElementById('kpiRev').innerText = '$'+(totRev/1e6).toFixed(2)+'M';
        
        // Charts (Simplified)
        if(CHART_LOAD) CHART_LOAD.destroy();
        const machLoad={}; SCHEDULE.forEach(r=>[r.card,r.fin,r.qc].forEach(t=>machLoad[t.mach]=(machLoad[t.mach]||0)+r.qty));
        CHART_LOAD = new Chart(document.getElementById('chartLoad'), {
            type: 'bar', data: { labels:Object.keys(machLoad), datasets:[{label:'Yards', data:Object.values(machLoad), backgroundColor:'#3b82f6'}] }, options:{maintainAspectRatio:false}
        });
    }

    // --- DIGITAL TWIN LOGIC ---
    let simCtx, simParticles=[], simRunning=false, lastTime=0, STATIONS=[];
    let BUFFERS=[Infinity, 5, Infinity]; // Feed, WIP, Out

    function initDigitalTwinCanvas() {
        const c = document.getElementById('simCanvas');
        c.width = c.offsetWidth; c.height = c.offsetHeight;
        simCtx = c.getContext('2d');
    }

    function updateFeltDropdown() {
        const s = document.getElementById('dtFeltSelect');
        if(s.options.length > 1) return; // already populated
        const uniqueFelts = [...new Set(SCHEDULE.map(s => s.felt))];
        uniqueFelts.forEach(f => s.innerHTML += `<option value="${f}">${f}</option>`);
    }

    function initDigitalTwin() {
        const felt = document.getElementById('dtFeltSelect').value;
        const r = RATES[felt] || {card:250, finish:700, qc:400};
        
        // Convert Rate (yds/hr) to Cycle Time (sec/yd)
        // CT = 3600 / Rate
        const ct1 = (3600 / r.card).toFixed(1);
        const ct2 = (3600 / r.finish).toFixed(1);
        const ct3 = (3600 / r.qc).toFixed(1);

        document.getElementById('v_ct1').innerText = ct1; document.getElementById('i_ct1').value = ct1;
        document.getElementById('v_ct2').innerText = ct2; document.getElementById('i_ct2').value = ct2;
        document.getElementById('v_ct3').innerText = ct3; document.getElementById('i_ct3').value = ct3;

        STATIONS = [
            { id:0, name:"Carding", mean:parseFloat(ct1), sigma:0.5, state:'idle', timer:0, items:0, starveT:0, blockT:0 },
            { id:1, name:"Finishing", mean:parseFloat(ct2), sigma:1.5, state:'idle', timer:0, items:0, starveT:0, blockT:0 },
            { id:2, name:"QC", mean:parseFloat(ct3), sigma:0.2, state:'idle', timer:0, items:0, starveT:0, blockT:0 }
        ];
        
        simParticles=[]; BUFFERS=[Infinity, 0, 0]; simRunning=true; lastTime=0;
        document.getElementById('btnToggleSim').innerText = "PAUSE";
        requestAnimationFrame(simLoop);
    }

    function updateDTParam(idx, type, val) {
        val = parseFloat(val);
        STATIONS[idx][type] = val;
        if(type==='mean') document.getElementById(`v_ct${idx+1}`).innerText = val.toFixed(1);
        if(type==='sigma') document.getElementById(`v_sig${idx+1}`).innerText = val.toFixed(1);
    }

    function getGaussian(mean, sigma) {
        let u=0, v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random();
        return Math.max(0.1, (Math.sqrt(-2.0*Math.log(u))*Math.cos(2.0*Math.PI*v))*sigma + mean);
    }

    function simLoop(ts) {
        if(!simRunning) return;
        const dt = (ts - lastTime)/1000; lastTime = ts;
        if(dt > 0.1) { requestAnimationFrame(simLoop); return; }
        const step = dt * 5; // 5x speed

        // S1 (Card)
        let s1 = STATIONS[0];
        if(s1.state==='idle') { s1.state='working'; s1.timer=getGaussian(s1.mean, s1.sigma); }
        else if(s1.state==='working') {
            s1.timer-=step;
            if(s1.timer<=0) { BUFFERS[1]++; s1.items++; spawnParticle(0); s1.state='idle'; }
        }

        // S2 (Finish) - Pulls from Buf1
        let s2 = STATIONS[1];
        if(s2.state==='idle') {
            if(BUFFERS[1]>0) { BUFFERS[1]--; s2.state='working'; s2.timer=getGaussian(s2.mean, s2.sigma); }
            else { s2.state='starved'; s2.starveT+=step; }
        } else if(s2.state==='working') {
            s2.timer-=step;
            if(s2.timer<=0) { s2.items++; spawnParticle(1); s2.state='idle'; } // Assuming infinite out for S2->S3 link simplification
        } else if(s2.state==='starved' && BUFFERS[1]>0) s2.state='idle';

        // S3 (QC) - Simplified for demo to follow S2
        let s3 = STATIONS[2];
        // For visual simplicity, let's just make S3 independent consumer to show rate diff
        if(s3.state==='idle') { s3.state='working'; s3.timer=getGaussian(s3.mean, s3.sigma); }
        else if(s3.state==='working') { s3.timer-=step; if(s3.timer<=0) { s3.items++; spawnParticle(2); s3.state='idle'; } }

        drawSim();
        requestAnimationFrame(simLoop);
    }

    function spawnParticle(idx) { simParticles.push({x:100+(idx*200), y:150, life:1}); }

    function drawSim() {
        const w = simCtx.canvas.width; const h = simCtx.canvas.height;
        simCtx.clearRect(0,0,w,h);
        
        // Draw Stations
        STATIONS.forEach((s, i) => {
            const x = 100 + (i*200); const y = 150;
            simCtx.fillStyle = s.state==='working' ? '#16a34a' : (s.state==='starved'?'#facc15':'#ef4444');
            simCtx.fillRect(x-30, y-30, 60, 60);
            simCtx.fillStyle='#1e293b'; simCtx.font='bold 12px Arial'; simCtx.fillText(s.name, x-20, y+45);
            simCtx.font='10px monospace'; simCtx.fillText(s.state.toUpperCase(), x-20, y-40);
        });

        // Draw Buffer 1
        simCtx.strokeStyle='#64748b'; simCtx.strokeRect(270, 120, 60, 60);
        simCtx.fillStyle='rgba(37,99,235,0.2)';
        const fill = Math.min(BUFFERS[1], 50)/50 * 60;
        simCtx.fillRect(270, 180-fill, 60, fill);
        simCtx.fillStyle='#000'; simCtx.fillText(`Q: ${BUFFERS[1]}`, 280, 200);

        // Particles
        simParticles.forEach(p => {
            p.x+=4; p.life-=0.01;
            simCtx.fillStyle=`rgba(37,99,235,${p.life})`;
            simCtx.beginPath(); simCtx.arc(p.x, p.y, 4, 0, Math.PI*2); simCtx.fill();
        });
        simParticles = simParticles.filter(p=>p.life>0);

        // Metrics
        const throughput = (STATIONS[1].items / (performance.now()/1000))*3600; // rough approx
        document.getElementById('dispDTThroughput').innerText = STATIONS[1].items;
        document.getElementById('dispDTWIP').innerText = BUFFERS[1];
    }
    
    function toggleSim() { simRunning=!simRunning; document.getElementById('btnToggleSim').innerText = simRunning?"PAUSE":"RESUME"; if(simRunning) requestAnimationFrame(simLoop); }
    function resetSim() { initDigitalTwin(); }

    // --- CAPEX LOGIC ---
    function estimateEnergy() {
        const totYds = SCHEDULE.reduce((a,b)=>a+b.qty,0);
        // Rough heuristic: 0.5 kWh per yard processed
        const est = (totYds * 0.5).toFixed(0);
        document.getElementById('baseEnergy').value = est;
        calcCapex();
    }

    function calcCapex() {
        const energy = parseFloat(document.getElementById('baseEnergy').value)||0;
        const cost = parseFloat(document.getElementById('energyCost').value)||0;
        const carbon = parseFloat(document.getElementById('carbonIntensity').value)||0;
        const capex = parseFloat(document.getElementById('capexVal').value)||0;
        const eff = parseFloat(document.getElementById('effGain').value)||0;

        const oldOpEx = energy * cost;
        const newEnergy = energy * (1 - eff/100);
        const newOpEx = newEnergy * cost;
        const savings = oldOpEx - newOpEx;
        
        const payback = savings > 0 ? capex/savings : 0;
        const roi = savings > 0 ? (savings/capex)*100 : 0;
        const co2Saved = ((energy - newEnergy)*carbon)/1000;

        document.getElementById('dispSavings').innerText = '$' + savings.toLocaleString(undefined,{maximumFractionDigits:0});
        document.getElementById('dispPayback').innerText = payback.toFixed(1) + " Yrs";
        document.getElementById('dispROI').innerText = roi.toFixed(1) + "%";
        document.getElementById('dispCarbon').innerText = co2Saved.toFixed(1);

        // Bars
        const max = Math.max(oldOpEx, savings*10);
        document.getElementById('barOldCost').style.height = (oldOpEx/max*100)+'%';
        document.getElementById('valOldCost').innerText = '$'+(oldOpEx/1000).toFixed(0)+'k';
        
        document.getElementById('barNewCost').style.height = (newOpEx/max*100)+'%';
        document.getElementById('valNewCost').innerText = '$'+(newOpEx/1000).toFixed(0)+'k';

        const net10y = (savings*10) - capex;
        document.getElementById('barCumSavings').style.height = (net10y/max*100)+'%';
        document.getElementById('valCumSavings').innerText = '$'+(net10y/1000).toFixed(0)+'k';

        document.getElementById('analysisText').innerHTML = `A <strong>$${capex.toLocaleString()}</strong> investment yielding <strong>${eff}% efficiency</strong> breaks even in <strong>${payback.toFixed(1)} years</strong>. 10-Year Net Benefit: <strong>$${net10y.toLocaleString()}</strong>.`;
    }

    // --- EXCEL & FILE HANDLING ---
    function readFile(f) { return new Promise(r=>{const rd=new FileReader(); rd.onload=e=>r(XLSX.read(new Uint8Array(e.target.result),{type:'array'})); rd.readAsArrayBuffer(f);}); }
    
    async function handleOrderUpload(i) {
        const wb=await readFile(i.files[0]); 
        let rows = [];
        for(const sn of wb.SheetNames) {
            const raw = XLSX.utils.sheet_to_json(wb.Sheets[sn], {header:1});
            const idx = raw.findIndex(r => r && r.some(c => String(c).toUpperCase().includes('ORDER')));
            if(idx > -1) { rows = XLSX.utils.sheet_to_json(wb.Sheets[sn], {range:idx}); break; }
        }
        RAW_ORDERS = rows.map((r, x)=>({
            id: r.OrderID || r['Order ID'] || `ORD-${x}`, 
            felt: r.Felt || r['Felt Code'] || 'UNK', 
            qty: parseFloat(r.Qty || r['Balance'] || r['Bal Yds'] || 0), 
            val: parseFloat(r.Val || r['Sales Value'] || 0), 
            rtsRaw: r['RTS Date'] || r.Date || r.ReqDate,
            status: r.Status || 'New'
        })).filter(o => o.qty > 0);
        
        // Date parsing fix
        RAW_ORDERS.forEach(o => {
            if(typeof o.rtsRaw === 'number') o.rtsDate = new Date(Math.round((o.rtsRaw - 25569)*86400*1000)).getTime();
            else if(o.rtsRaw) o.rtsDate = new Date(o.rtsRaw).getTime();
            else o.rtsDate = new Date('2099-12-31').getTime();
        });

        document.getElementById('orderStatus').innerText = RAW_ORDERS.length + " Orders";
    }

    async function handleRateUpload(inp) {
        const wb = await readFile(inp.files[0]);
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        data.forEach(r => {
            const code = r['Felt Code'] || r['Code'];
            if(code) RATES[code.trim()] = { card: parseFloat(r['Carding Rate (yds/hr)']||250), finish: parseFloat(r['Finishing Rate (yds/hr)']||700), qc: parseFloat(r['QC Rate (yds/hr)']||400) };
        });
        document.getElementById('rateStatus').innerText = "Rates Loaded";
    }

    async function handleRouteUpload(inp) {
        const wb = await readFile(inp.files[0]);
        let sheetName = wb.SheetNames.find(n => n.includes('Sheet4')) || wb.SheetNames[0];
        const data = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
        let tempRoutes = {};
        data.forEach(r => {
            const felt = r['FELTCODE']; const mach = r['MACHNAME'];
            if(felt && mach) {
                if(!tempRoutes[felt]) tempRoutes[felt] = { card:[], fin:[], qc:[] };
                const mUpper = mach.toUpperCase();
                // Simple normalization
                const normMach = CONFIG.machines.find(m => m.toUpperCase().replace(/\s/g,'') === mach.toUpperCase().replace(/\s/g,'').replace('#','')) || mach;
                if(mUpper.includes('CARD')) tempRoutes[felt].card.push(normMach);
                else if(mUpper.includes('QC')) tempRoutes[felt].qc.push(normMach);
                else tempRoutes[felt].fin.push(normMach);
            }
        });
        ROUTES = tempRoutes;
        document.getElementById('routeStatus').innerText = "Routes Loaded";
    }

    function switchView(v) {
        document.querySelectorAll('[id^="view-"]').forEach(e=>e.classList.add('hidden'));
        document.getElementById('view-'+v).classList.remove('hidden');
        if(v==='twin') updateFeltDropdown();
    }
    function showModal(id) { document.getElementById(id).style.display='flex'; }
    function changeZoom(d) { ZOOM_PX=Math.max(20, ZOOM_PX+d); renderGantt(SCHEDULE); }
    function openEdit(id) { document.getElementById('editOrderModal').style.display='flex'; }
</script>
</body>
</html>
